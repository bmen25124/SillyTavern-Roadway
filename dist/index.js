import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as a from"../../../../openai.js";import*as i from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";var l={d:(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const p=(e=>{var t={};return l.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const u=(e=>{var t={};return l.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const m=(e=>{var t={};return l.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const d=(e=>{var t={};return l.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const f=(e=>{var t={};return l.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const h=(e=>{var t={};return l.d(t,e),t})({formatWorldInfo:()=>a.formatWorldInfo,getPromptPosition:()=>a.getPromptPosition,getPromptRole:()=>a.getPromptRole,prepareOpenAIMessages:()=>a.prepareOpenAIMessages,setOpenAIMessageExamples:()=>a.setOpenAIMessageExamples,setOpenAIMessages:()=>a.setOpenAIMessages});const g=(e=>{var t={};return l.d(t,e),t})({metadata_keys:()=>i.metadata_keys});const v=(e=>{var t={};return l.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const y=(e=>{var t={};return l.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});async function x(e,t){await SillyTavern.getContext().SlashCommandParser.commands.echo.callback({severity:e},t)}function _(e){return(0,u.getMaxContextSize)(e)}function w(e,t){return(0,u.parseMesExamples)(e,t)}function P(e,t,n){return(0,u.baseChatReplace)(e,t,n)}function b(e){return(0,h.getPromptRole)(e)}function S(e,{wiFormat:t}={}){return(0,h.formatWorldInfo)(e,{wiFormat:t})}function C(e){return(0,h.getPromptPosition)(e)}async function E(e,t,{presetName:n,instructName:r,contextName:o,syspromptName:a,maxContext:i}={}){if(!e)throw new Error("API is required");if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const s=SillyTavern.getContext();let c=[],{description:l,personality:x,persona:E,scenario:I,mesExamples:O,system:k,jailbreak:T}=s.getCharacterCardFields();const A="textgenerationwebui"===e?s.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,M=!!A?.enabled;let N=w(O,M);const R=function(){if("number"==typeof i)return i;if(!i)return _();if("active"===i||!n)return _();if("number"==typeof i)return i;let t;if("textgenerationwebui"===e){const e=s.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=s.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:_()}();if(R<=0)return[];const L=s.ToolManager.isToolCallingSupported();let j=s.chat.slice(0,t?t+1:void 0).filter((e=>!e.is_system||L&&Array.isArray(e.extra?.tool_invocations)));j=await Promise.all(j.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i}){return(0,y.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i})}(e.mes,e.is_user?y.regex_placement.USER_INPUT:y.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:j.length-t-1});return n=await async function(e,t){return await(0,f.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const $=j.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:D,worldInfoBefore:B,worldInfoAfter:U,worldInfoExamples:F,worldInfoDepth:G,anBefore:q,anAfter:V}=await s.getWorldInfoPrompt($,R,!1);for(const ee of F){const te=ee.content;if(0===te.length)continue;const ne=w(P(te,u.name1,u.name2),M);ee.position===m.wi_anchor_position.before?N.unshift(...ne):N.push(...ne)}if("textgenerationwebui"===e){const re=[...N];N&&(N=function(e,t,n){return(0,d.formatInstructModeExamples)(e,t,n)}(N,u.name1,u.name2));const oe=s.getPresetManager("sysprompt")?.getCompletionPresetByName(a);oe&&(k=s.powerUserSettings.prefer_character_prompt&&k?k:P(oe.content,u.name1,u.name2),k=M?(z=s.substituteParams(k,u.name1,u.name2,oe.content),W=A,(0,d.formatInstructModeSystemPrompt)(z,W)):k);const ae={description:l,personality:x,persona:s.powerUserSettings.persona_description_position==p.persona_description_positions.IN_PROMPT?E:"",scenario:I,system:k,char:u.name2,user:u.name1,wiBefore:B,wiAfter:U,loreBefore:B,loreAfter:U,mesExamples:N.join(""),mesExamplesRaw:re.join("")},ie=s.getPresetManager("context")?.getCompletionPresetByName(o);let se=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,p.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(ae,{customInstructSettings:A,customStoryString:ie?.story_string});c.push({role:"system",content:se,ignoreInstruct:!0});let ce=0;const le=[];for(let pe=j.length-1;pe>=0;pe--){const ue=j[pe];if(ue.extra?.token_count&&ce+ue.extra.token_count>R)break;ce+=ue.extra?.token_count||0,le.unshift({role:ue.is_user?"user":"assistant",content:ue.mes})}c.push(...le)}else{let me=(H=j,(0,h.setOpenAIMessages)(H)),de=function(e){return(0,h.setOpenAIMessageExamples)(e)}(N);async function fe(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,extensionPrompts:p,cyclePrompt:u,systemPromptOverride:m,jailbreakPromptOverride:d,personaDescription:f,messages:g,messageExamples:v},y){return(0,h.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,cyclePrompt:u,systemPromptOverride:m,jailbreakPromptOverride:d,personaDescription:f,extensionPrompts:p,messages:g,messageExamples:v},y)}({name2:u.name2,charDescription:l,charPersonality:x,Scenario:I,worldInfoBefore:B,worldInfoAfter:U,extensionPrompts:s.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:k,jailbreakPromptOverride:T,personaDescription:E,messages:me,messageExamples:de},!1);c.push(...e)}if(!n)return await fe(),c;const he=s.getPresetManager("openai")?.getCompletionPresetByName(n);if(!he)return console.warn(`Preset not found: ${n}. Using current preset.`),fe(),c;let ge=he.prompt_order.find((e=>e.character_id===u.this_chid));if(!ge&&he.prompt_order.length>0&&(ge=he.prompt_order[0]),!ge)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),fe(),c;const ve=I&&he.scenario_format?s.substituteParams(he.scenario_format):"",ye=x&&he.personality_format?s.substituteParams(he.personality_format):"",xe=s.substituteParams(he.group_nudge_prompt),_e=he.impersonation_prompt?s.substituteParams(he.impersonation_prompt):"",we=[{role:"system",content:S(B,{wiFormat:he.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:S(U,{wiFormat:he.wi_format}),identifier:"worldInfoAfter"},{role:"system",content:l,identifier:"charDescription"},{role:"system",content:ye,identifier:"charPersonality"},{role:"system",content:ve,identifier:"scenario"},{role:"system",content:_e,identifier:"impersonate"},{role:"system",content:xe,identifier:"groupNudge"}],Pe=s.extensionPrompts["1_memory"];Pe&&Pe.value&&we.push({role:b(Pe.role),content:Pe.value,identifier:"summary",position:C(Pe.position)});const be=s.extensionPrompts["2_floating_prompt"];be&&be.value&&we.push({role:b(be.role),content:be.value,identifier:"authorsNote",position:C(be.position)});const Se=s.extensionPrompts["3_vectors"];Se&&Se.value&&we.push({role:"system",content:Se.value,identifier:"vectorsMemory",position:C(Se.position)});const Ce=s.extensionPrompts["4_vectors_data_bank"];Ce&&Ce.value&&we.push({role:b(Ce.role),content:Ce.value,identifier:"vectorsDataBank",position:C(Ce.position)});const Ee=s.extensionPrompts.chromadb;Ee&&Ee.value&&we.push({role:"system",content:Ee.value,identifier:"smartContext",position:C(Ee.position)}),s.powerUserSettings.persona_description&&s.powerUserSettings.persona_description_position===p.persona_description_positions.IN_PROMPT&&we.push({role:"system",content:s.powerUserSettings.persona_description,identifier:"personaDescription"}),ge.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,we.find((e=>e.identifier===n)));var n;if(t&&t.content)c.push({role:t.role??"system",content:s.substituteParams(t.content)});else if("chatHistory"===e.identifier){let e=0;const t=[];for(let n=j.length-1;n>=0;n--){const r=j[n];if(r.extra?.token_count&&e+r.extra.token_count>R)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:r.mes})}c.push(...t)}}))}var H,z,W;const Y=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ie in s.extensionPrompts)if(Object.hasOwn(s.extensionPrompts,Ie)){const Oe=s.extensionPrompts[Ie];if(Y.includes(Ie))continue;if(!s.extensionPrompts[Ie].value)continue;if(![u.extension_prompt_types.BEFORE_PROMPT,u.extension_prompt_types.IN_PROMPT].includes(Oe.position))continue;if("function"==typeof Oe.filter&&!await Oe.filter())continue;Oe.position===u.extension_prompt_types.BEFORE_PROMPT?c=[...c.slice(0,Oe.depth),{role:b(Oe.role)??"system",content:Oe.value},...c.slice(Oe.depth)]:Oe.position===u.extension_prompt_types.IN_PROMPT&&(c=[...c.slice(0,c.length-Oe.depth),{role:b(Oe.role)??"system",content:Oe.value},...c.slice(c.length-Oe.depth)])}for(const ke of G)c=[...c.slice(0,c.length-ke.depth),{role:b(ke.role),content:ke.entries.join("\n")},...c.slice(c.length-ke.depth)];const K=(Q=v.selected_group,J=Number(u.this_chid),(0,v.getGroupDepthPrompts)(Q,J));var Q,J;if(v.selected_group&&Array.isArray(K)&&K.length>0)K.forEach(((e,t)=>{c=[...c.slice(0,c.length-e.depth),{role:e.role,content:e.text},...c.slice(c.length-e.depth)]}));else{const Te=P(u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),u.name1,u.name2)||"",Ae=u.depth_prompt_depth_default,Me=u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.role??u.depth_prompt_role_default;c=[...c.slice(0,c.length-Ae),{role:b(Me),content:Te},...c.slice(c.length-Ae)]}const X={prompt:u.chat_metadata[g.metadata_keys.prompt],interval:u.chat_metadata[g.metadata_keys.interval],position:u.chat_metadata[g.metadata_keys.position],depth:u.chat_metadata[g.metadata_keys.depth],role:u.chat_metadata[g.metadata_keys.role]};let Z=-1;if(X.prompt)switch(X.prompt=P(X.prompt,u.name1,u.name2),X.position){case u.extension_prompt_types.IN_PROMPT:c=[...c.slice(0,1),{role:"user",content:X.prompt},...c.slice(1)],Z=1;break;case u.extension_prompt_types.IN_CHAT:c=[...c.slice(0,c.length-X.depth),{role:b(X.role),content:X.prompt},...c.slice(c.length-X.depth)],Z=c.length-X.depth-1;break;case u.extension_prompt_types.BEFORE_PROMPT:c.unshift({role:"user",content:X.prompt}),Z=0}return Z>=0&&(q.length>0&&(c=[...c.slice(0,Z),{role:"system",content:q.join("\n")},...c.slice(Z)],Z++),V.length>0&&(c=[...c.slice(0,Z+1),{role:"system",content:V.join("\n")},...c.slice(Z+1)])),c}function I(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const a=t.label||"preset",i=document.createElement("div");i.className="preset-select-container",i.style.display="flex",i.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(i,o),i.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,s(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${a}`,e.setAttribute("data-i18n",`[title]Create a new ${a}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await n.Popup.show.input(`Create a new ${a}`,`Please enter a name for the new ${a}:`,"");if(null===e||""===e.trim())return;const r=e.trim();if(Array.from(o.options).some((e=>e.textContent===r)))return void await x("warning",`A ${a} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(r))return}const i=document.createElement("option");i.value=r,i.textContent=r,o.appendChild(i),o.value=r,t.create?.onAfterCreate&&await t.create.onAfterCreate(r);const s=o.value;t.onSelectChange&&s!==r&&await t.onSelectChange(s,r),c=r})),i.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${a}`,e.setAttribute("data-i18n",`[title]Rename a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await x("warning",`Please select a ${a} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await x("warning",`This ${a} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const i=await n.Popup.show.input(`Rename ${a}`,`Please enter a new name for "${r}":`,r);if(null===i||""===i.trim()||i===r)return;const l=i.trim();if(Array.from(o.options).some((t=>t.textContent===l&&t!==e)))await x("warning",`A ${a} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,l))return}e.value=l,e.textContent=l,r===c&&(c=l),t.rename?.onAfterRename&&await t.rename.onAfterRename(r,l),t.onSelectChange&&o.value===l&&await t.onSelectChange(r,l)}})),i.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${a}`,e.setAttribute("data-i18n",`[title]Delete a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await x("warning",`Please select a ${a} to delete.`);const e=o.options[o.selectedIndex],r=e.value,i=o.selectedIndex;if(s(r))return void await x("warning",`This ${a} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Are you sure you want to delete "${r}"?`,`Delete ${a}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const l=r;let p,u=-1;o.options.length>1&&(u=i<o.options.length-1?i:i-1,p=o.options[u].value),o.removeChild(e),u>=0?(o.selectedIndex=u,c=p,t.onSelectChange&&await t.onSelectChange(l,p)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),i.appendChild(e)}return{select:o,container:i}}function O(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=M(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=M(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==M(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */k=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function p(e,t,n,r){var a=t&&t.prototype instanceof v?t:v,i=Object.create(a.prototype),s=new A(r||[]);return o(i,"_invoke",{value:E(e,n,s)}),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=p;var m="suspendedStart",d="suspendedYield",f="executing",h="completed",g={};function v(){}function y(){}function x(){}var _={};l(_,i,(function(){return this}));var w=Object.getPrototypeOf,P=w&&w(w(N([])));P&&P!==n&&r.call(P,i)&&(_=P);var b=x.prototype=v.prototype=Object.create(_);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(o,a,i,s){var c=u(e[o],e,a);if("throw"!==c.type){var l=c.arg,p=l.value;return p&&"object"==M(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function E(t,n,r){var o=m;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===h){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var s=r.delegate;if(s){var c=I(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===m)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=u(t,n,r);if("normal"===l.type){if(o=r.done?h:d,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function I(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,I(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=u(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(M(t)+" is not iterable")}return y.prototype=x,o(b,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},S(C.prototype),l(C.prototype,s,(function(){return this})),t.AsyncIterator=C,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new C(p(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},S(b),l(b,c,"Generator"),l(b,i,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),l=r.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;T(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function T(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function A(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){T(a,r,o,i,s,"next",e)}function s(e){T(a,r,o,i,s,"throw",e)}i(void 0)}))}}function M(e){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M(e)}var N=SillyTavern.getContext(),R="roadway_target_chat",L="roadway_raw_content",j="roadway_options",D="roadway";function B(){return SillyTavern.getContext().extensionSettings[D]}var U,F="Continue as {{user}}. This what {{user}} selected:\n\n{{roadway_selected}}",G="You are an AI brainstorming partner, helping to create immersive and surprising roleplaying experiences. Given the following context, your task is to generate an *unpredictable* and *engaging* list of options for the player.\n\nOutput ONLY a numbered list of possible actions. Each action should be a clear, actionable, concise, and *creative* sentence written in plain text.\n\nPrioritize *varied* actions that span multiple domains:\n\n{Observation/Investigation; Dialogue/Persuasion; Stealth/Intrigue; Combat/Conflict; Crafting/Repair; Knowledge/Lore; Movement/Traversal; Deception/Manipulation; Performance/Entertainment; Technical/Mechanical}.\n\nAvoid obvious or repetitive actions. Push the boundaries of the situation. Challenge the player's expectations. Do not include greetings, farewells, polite thanks, or options that break character. Generate *exactly* 10 actions. The actions must be written in plain text.\n\nHere are a few example actions to inspire creativity:\n\n1. Attempt to communicate with the forest creatures to learn the location of hidden trails.\n2. Bribe the corrupt city guard with a song and a dance.\n3. Stage a fake ambush to draw out a hidden enemy.",q={profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:500,promptPreset:"default",promptPresets:{default:{content:G,extractionStrategy:"bullet",impersonate:F}}};function V(){return V=A(k().mark((function e(){var t,n,r,o,a,i,s,c,l,p,m,d,f,h,g,v,y,_;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _=function(e){var t=document.createElement("details"),n=document.createElement("summary"),r=document.createElement("pre");return r.classList.add("roadway_pre"),n.textContent="Roadway",r.textContent=e,t.append(n,r),t.outerHTML},m=function(){var e=B(),t=e.promptPresets[e.promptPreset];c.val(null==t?void 0:t.extractionStrategy);var n="none"===(null==t?void 0:t.extractionStrategy);l.toggle(!n),p.val((null==t?void 0:t.impersonate)||"")},e.next=4,N.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 4:n=e.sent,$("#extensions_settings").append(n),r=$(".roadway_settings"),N.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",B().profileId,(function(e){var t=SillyTavern.getContext();B().profileId=e?e.id:"",t.saveSettingsDebounced()})),o=B(),a=I(".roadway_settings select.prompt",{label:"prompt",initialValue:o.promptPreset,initialList:Object.keys(o.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=A(k().mark((function e(t,n){var r,a,i,u;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(o=B()).promptPreset=null!=n?n:"default",s.val((null===(r=o.promptPresets[o.promptPreset])||void 0===r?void 0:r.content)||""),c.val(null===(a=o.promptPresets[o.promptPreset])||void 0===a?void 0:a.extractionStrategy),p.val((null===(i=o.promptPresets[o.promptPreset])||void 0===i?void 0:i.impersonate)||""),l.css("display","none"===(null===(u=o.promptPresets[o.promptPreset])||void 0===u?void 0:u.extractionStrategy)?"none":"block"),N.saveSettingsDebounced();case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n,r;(o=B()).promptPresets[e]={content:(null===(t=o.promptPresets[o.promptPreset])||void 0===t?void 0:t.content)||G,extractionStrategy:(null===(n=o.promptPresets[o.promptPreset])||void 0===n?void 0:n.extractionStrategy)||"bullet",impersonate:(null===(r=o.promptPresets[o.promptPreset])||void 0===r?void 0:r.impersonate)||F},N.saveSettingsDebounced()}},rename:{onAfterRename:function(e,t){(o=B()).promptPresets[t]=o.promptPresets[e],delete o.promptPresets[e],N.saveSettingsDebounced()}},delete:{onAfterDelete:function(e){delete(o=B()).promptPresets[e],N.saveSettingsDebounced()}}}),i=a.select,(s=r.find("textarea.prompt")).val((null===(t=o.promptPresets[o.promptPreset])||void 0===t?void 0:t.content)||""),s.on("change",(function(){o=B();var e=s.val();o.promptPresets[o.promptPreset].content=e,N.saveSettingsDebounced()})),c=r.find("select.extraction_strategy"),l=r.find(".impersonate_section"),p=r.find("textarea.impersonate"),m(),c.on("change",(function(){o=B();var e=$(this).val();o.promptPresets[o.promptPreset].extractionStrategy=e;var t="none"===e;l.toggle(!t),N.saveSettingsDebounced()})),p.on("change",(function(){(o=B()).promptPresets[o.promptPreset].impersonate=$(this).val(),N.saveSettingsDebounced()})),i.addEventListener("change",m),r.find(".restore_default").on("click",A(k().mark((function e(){var t;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N.Popup.show.confirm("Are you sure you want to restore the default prompt?","Restore default");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:(t=B()).promptPresets.default.content=G,t.promptPresets.default.extractionStrategy="bullet",t.promptPresets.default.impersonate=F,s.val(G),c.val("bullet"),p.val(F),"default"!==i.value?(i.value="default",i.dispatchEvent(new Event("change"))):N.saveSettingsDebounced();case 13:case"end":return e.stop()}}),e)})))),d=r.find(".max_context_type"),f=r.find(".max_context_value"),h=r.find(".max_context_custom"),d.val(B().maxContextType),f.val(B().maxContextValue),"custom"===B().maxContextType&&h.show(),d.on("change",(function(){var e=SillyTavern.getContext(),t=B(),n=$(this).val();t.maxContextType=n,h.toggle("custom"===n),e.saveSettingsDebounced()})),f.on("change",(function(){var e=SillyTavern.getContext();B().maxContextValue=Number($(this).val()),e.saveSettingsDebounced()})),(g=r.find(".max_response_tokens")).val(B().maxResponseToken),g.on("change",(function(){var e=SillyTavern.getContext();B().maxResponseToken=Number($(this).val()),e.saveSettingsDebounced()})),v=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(v),y=new Set,$(document).on("click",".mes_magic_roadway_button",A(k().mark((function e(){var t,n,r,o,a,i,s,c,l,p,m,d,f,h,g,v,w,P,b,S,C;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),(r=B()).profileId){e.next=6;break}return e.next=5,x("error","Please select a connection profile first in the settings.");case 5:case 9:case 22:return e.abrupt("return");case 6:if(r.promptPreset){e.next=10;break}return e.next=9,x("error","Please enter a prompt first in the settings.");case 10:if(o=$(this).closest(".mes"),a=Number(o.attr("mesid")),i=null===(t=n.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find((function(e){return e.id===r.profileId})),s=null==i?void 0:i.preset,c=null==i?void 0:i.context,l=null==i?void 0:i.instruct,p=null==i?void 0:i.sysprompt,m=null!=i&&i.api?n.CONNECT_API_MAP[i.api]:null,e.prev=18,!y.has(a)){e.next=23;break}return e.next=22,x("warning","A request for this message is already in progress. Please wait.");case 23:return y.add(a),$(this).addClass("spinning"),e.next=27,E(null==m?void 0:m.selected,a,{presetName:s,contextName:c,instructName:l,syspromptName:p,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active"});case 27:return(h=e.sent).push({content:n.substituteParams(r.promptPresets[r.promptPreset].content),role:"system"}),e.next=31,n.ConnectionManagerRequestService.sendRequest(r.profileId,h,r.maxResponseToken);case 31:if(g=e.sent,v=[],"bullet"!==(null===(d=r.promptPresets[r.promptPreset])||void 0===d?void 0:d.extractionStrategy)){e.next=39;break}if(I=g.content,k=void 0,k=I.match(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)(.*)$/gm)||[],0!==(v=k.map((function(e){return e.replace(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)/,"").trim()}))).length){e.next=39;break}return e.next=39,x("warning","Could not extract any bullet points from the response. Using original response.");case 39:return w=null!==(f=v)&&void 0!==f&&f.length?v.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"):g.content,P=n.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t[R])===a})),b=null!=P?P:{mes:_(w),name:u.systemUserName,force_avatar:u.system_avatar,is_system:!0,is_user:!1,extra:O(O(O({isSmallSys:!0},R,a),L,w),j,v)},P?(b.mes=_(w),b.extra[L]=g.content,b.extra[j]=v,S=n.chat.indexOf(P),$('[mesid="'.concat(S,'"] .mes_text pre')).text(w)):(n.chat.push(b),n.addOneMessage(b,{insertAfter:a})),(C=$('[mesid="'.concat(a+1,'"] .mes_text details'))).attr("open")||C.attr("open",""),e.next=47,n.saveChat();case 47:e.next=54;break;case 49:return e.prev=49,e.t0=e.catch(18),console.error(e.t0),e.next=54,x("error","Error: ".concat(e.t0));case 54:return e.prev=54,y.delete(a),$(".mes_magic_roadway_button").removeClass("spinning"),e.finish(54);case 58:case"end":return e.stop()}var I,k}),e,this,[[18,49,54,58]])}))));case 36:case"end":return e.stop()}}),e)}))),V.apply(this,arguments)}N.extensionSettings[D]=(null===(U=N.extensionSettings)||void 0===U?void 0:U[D])||{},function e(t,n){for(var r=!1,o=0,a=Object.keys(n);o<a.length;o++){var i=a[o];void 0===t[i]?(t[i]=n[i],r=!0):"object"===M(n[i])&&null!==n[i]&&(t[i]=t[i]||{},e(t[i],n[i])&&(r=!0))}return r}(N.extensionSettings[D],q)&&N.saveSettingsDebounced(),function(){V.apply(this,arguments)}();