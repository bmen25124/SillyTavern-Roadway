import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as o from"../../../../instruct-mode.js";import*as r from"../../../../chats.js";import*as i from"../../../../openai.js";import*as a from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as l from"../../../regex/engine.js";import*as c from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import*as d from"../../../../slash-commands/SlashCommandEnumValue.js";var p={d:(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};Error;const f=(e=>{var t={};return p.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const h=(e=>{var t={};return p.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const m=(e=>{var t={};return p.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const g=(e=>{var t={};return p.d(t,e),t})({formatInstructModeExamples:()=>o.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>o.formatInstructModeSystemPrompt});const v=(e=>{var t={};return p.d(t,e),t})({appendFileContent:()=>r.appendFileContent});const _=(e=>{var t={};return p.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const y=(e=>{var t={};return p.d(t,e),t})({metadata_keys:()=>a.metadata_keys});const b=(e=>{var t={};return p.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const E=(e=>{var t={};return p.d(t,e),t})({getRegexedString:()=>l.getRegexedString,regex_placement:()=>l.regex_placement});(e=>{var t={};p.d(t,e)})({});(e=>{var t={};p.d(t,e)})({});(e=>{var t={};p.d(t,e)})({});async function w(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}async function S(e,t,{escapeHtml:n=!0}={}){await w("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function x(e){return(0,h.getMaxContextSize)(e)}function T(e,t){return(0,h.parseMesExamples)(e,t)}function C(e,t,n){return(0,h.baseChatReplace)(e,t,n)}function P(e){return(0,_.getPromptRole)(e)}function A(e,{wiFormat:t}={}){return(0,_.formatWorldInfo)(e,{wiFormat:t})}function D(e){return(0,_.getPromptPosition)(e)}function O(e,t={}){const n=SillyTavern.getContext(),o=t.readOnlyValues||[],r=document.querySelector(e);if(!r)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,a=document.createElement("div");a.className="preset-select-container",a.style.display="flex",a.style.alignItems="center";const s=e=>o.includes(e);if(r.parentNode?.insertBefore(a,r),a.appendChild(r),t.initialList&&t.initialList.length>0){r.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),o=e(n);t.value=o,t.textContent=i(o),s(o)&&(t.dataset.readonly="true"),r.appendChild(t)}}if(t.initialValue){const e=Array.from(r.options).find((e=>e.value===t.initialValue));e&&(r.value=e.value)}let l=r.value;if(r.addEventListener("change",(async()=>{const e=r.value;t.onSelectChange&&l!==e&&await t.onSelectChange(l,e),l=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const o=i("");e.title=`Create a new ${o}`,e.setAttribute("data-i18n",`[title]Create a new ${o}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),o=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===o||""===o.trim())return;let a=o.trim();if(Array.from(r.options).some((e=>e.value===a)))return void await S("warning",`A ${i(a)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(a))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(a);"string"==typeof e&&(a=e)}const s=document.createElement("option");s.value=a,s.textContent=i(a),r.appendChild(s);const c=r.value;r.value=a,t.onSelectChange&&c!==a&&await t.onSelectChange(c,a),l=a})),a.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const o=i("");e.title=`Rename a ${o}`,e.setAttribute("data-i18n",`[title]Rename a ${o}`),e.addEventListener("click",(async()=>{if(-1===r.selectedIndex)return void await S("warning",`Please select a ${i("")} to rename.`);const e=r.options[r.selectedIndex];let o=e.value;if(s(o))return void await S("warning",`This ${i(o)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const a=await n.Popup.show.input(`Rename ${i(o)}`,`Please enter a new name for "${o}":`,o);if(null===a||""===a.trim()||a===o)return;let c=a.trim();if(Array.from(r.options).some((t=>t.value===c&&t!==e)))await S("warning",`A ${i(c)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(o,c))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(o,c);"string"==typeof e&&(c=e)}e.value=c,e.textContent=i(c),o===l&&(l=c),t.onSelectChange&&r.value===c&&await t.onSelectChange(o,c)}})),a.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const o=i("");e.title=`Delete a ${o}`,e.setAttribute("data-i18n",`[title]Delete a ${o}`),e.addEventListener("click",(async()=>{if(-1===r.selectedIndex)return void await S("warning",`Please select a ${i("")} to delete.`);const e=r.options[r.selectedIndex],o=e.value,a=r.selectedIndex;if(s(o))return void await S("warning",`This ${i(o)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(o)}`,`Are you sure you want to delete "${o}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(o))return}const c=o;let u,d=-1;r.options.length>1&&(d=a<r.options.length-1?a:a-1,u=r.options[d].value),r.removeChild(e),d>=0?(r.selectedIndex=d,l=u,t.onSelectChange&&await t.onSelectChange(c,u)):(t.onSelectChange&&await t.onSelectChange(c,void 0),l=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(c)})),a.appendChild(e)}return{select:r,container:a}}class R{encode(e){const t=Math.ceil(e.length/4);return new Array(t).fill(" ")}decode(e){return e.join("")}}class I{messages=[];tokenizer;maxContext;currentTokenCount=0;constructor(e){this.tokenizer=new R,this.maxContext=e}getTokenCount(e){return e.content?e.source?.extra?.token_count??this.tokenizer.encode(e.content).length:0}canFit(e){return this.currentTokenCount+this.getTokenCount(e)<=this.maxContext}add(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.push(e),this.currentTokenCount+=t,!0)}addFront(e){if(!e.content)return!0;const t=this.getTokenCount(e);return!(this.currentTokenCount+t>this.maxContext)&&(this.messages.unshift(e),this.currentTokenCount+=t,!0)}addMany(e){const t=e.filter((e=>e.content)),n=t.map((e=>this.getTokenCount(e))),o=n.reduce(((e,t)=>e+t),0);if(this.currentTokenCount+o<=this.maxContext)return this.messages.push(...t),this.currentTokenCount+=o,!0;let r=0;const i=[];for(let e=t.length-1;e>=0;e--){const o=t[e],a=n[e];if(!(this.currentTokenCount+r+a<=this.maxContext))break;i.unshift(o),r+=a}return i.length>0&&(this.messages.push(...i),this.currentTokenCount+=r),i.length===t.length}insert(e,t){if(!t.content)return!0;const n=this.getTokenCount(t);return!(this.currentTokenCount+n>this.maxContext)&&(this.messages.splice(e,0,t),this.currentTokenCount+=n,!0)}getMessages(){return this.messages}}async function N(e,{targetCharacterId:t,presetName:n,instructName:o,contextName:r,syspromptName:i,maxContext:a,includeNames:s,ignoreCharacterFields:l,ignoreAuthorNote:c,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let{description:w,personality:S,persona:O,scenario:R,mesExamples:N,system:M,jailbreak:k}=l?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const L="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(o):void 0,F=!!L?.enabled;let B=T(N,F);let G=[];const j=function(){if("number"==typeof a)return a;if(!a)return x();if("active"===a||!n)return x();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:x()}();if(j<=0)return{result:[],warnings:G};const $=new I(j),H=p.ToolManager.isToolCallingSupported(),U=d?.start??0,Y=d?.end?d.end+1:void 0;let V=-1===U&&0===Y?[]:p.chat.slice(U,Y).filter((e=>!e.is_system||H&&Array.isArray(e.extra?.tool_invocations)));V=await Promise.all(V.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:o,isPrompt:r,isEdit:i,depth:a}){return(0,E.getRegexedString)(e,t,{characterOverride:n,isMarkdown:o,isPrompt:r,isEdit:i,depth:a})}(e.mes,e.is_user?E.regex_placement.USER_INPUT:E.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:V.length-t-1});return n=await async function(e,t){return await(0,v.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const X=V.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:q,worldInfoBefore:W,worldInfoAfter:z,worldInfoExamples:K,worldInfoDepth:Q,anBefore:Z,anAfter:J}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(X,j,!1);for(const le of K){const ce=le.content;if(0===ce.length)continue;const ue=T(C(ce,h.name1,h.name2),F);le.position===m.wi_anchor_position.before?B.unshift(...ue):B.push(...ue)}function ee(){const e=[];for(let t=V.length-1;t>=0;t--){const n=V[t],o="System"!==n.name||n.is_user?n.is_user?"user":"assistant":"system";e.unshift({role:o,content:s&&"system"!=o?`${n.name}: ${n.mes}`:n.mes,source:n})}$.addMany(e)}if("textgenerationwebui"===e){const de=[...B];B&&(B=function(e,t,n){return(0,g.formatInstructModeExamples)(e,t,n)}(B,h.name1,h.name2));const pe=p.getPresetManager("sysprompt")?.getCompletionPresetByName(i);pe&&(M=p.powerUserSettings.prefer_character_prompt&&M?M:C(pe.content,h.name1,h.name2),M=F?(ne=p.substituteParams(M,h.name1,h.name2,pe.content),oe=L,(0,g.formatInstructModeSystemPrompt)(ne,oe)):M);const fe={description:w,personality:S,persona:p.powerUserSettings.persona_description_position==f.persona_description_positions.IN_PROMPT?O:"",scenario:R,system:M,char:h.name2,user:h.name1,wiBefore:W,wiAfter:z,loreBefore:W,loreAfter:z,mesExamples:B.join(""),mesExamplesRaw:de.join("")},he=p.getPresetManager("context")?.getCompletionPresetByName(r);let me=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,f.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(fe,{customInstructSettings:L,customStoryString:he?.story_string});me&&$.add({role:"system",content:me,ignoreInstruct:!0}),ee()}else{let ge=(te=V,(0,_.setOpenAIMessages)(te)),ve=function(e){return(0,_.setOpenAIMessageExamples)(e)}(B);async function _e(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:o,worldInfoBefore:r,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,messages:m,messageExamples:g},v){return(0,_.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:o,worldInfoBefore:r,worldInfoAfter:i,bias:a,type:s,quietPrompt:l,quietImage:c,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:f,personaDescription:h,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:h.name2,charDescription:w,charPersonality:S,Scenario:R,worldInfoBefore:W,worldInfoAfter:z,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:M,jailbreakPromptOverride:k,personaDescription:O,messages:ge,messageExamples:ve},!1);$.addMany(e)}if(!n)return G.push("No preset name provided. Using default preset."),await _e(),{result:$.getMessages(),warnings:G};const ye=p.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ye)return console.warn(`Preset not found: ${n}. Using current preset.`),G.push(`Preset not found: ${n}. Using current preset.`),_e(),{result:$.getMessages(),warnings:G};let be=ye.prompt_order?.find((e=>e.character_id===h.this_chid));if(!be&&ye.prompt_order&&ye.prompt_order.length>0&&(be=ye.prompt_order[0]),!be)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),G.push(`No prompt order found for preset: ${n}. Using current preset.`),_e(),{result:$.getMessages(),warnings:G};const Ee=R&&ye.scenario_format?p.substituteParams(ye.scenario_format):"",we=S&&ye.personality_format?p.substituteParams(ye.personality_format):"",Se=p.substituteParams(ye.group_nudge_prompt),xe=ye.impersonation_prompt?p.substituteParams(ye.impersonation_prompt):"",Te=[];u||Te.push({role:"system",content:A(W,{wiFormat:ye.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:A(z,{wiFormat:ye.wi_format}),identifier:"worldInfoAfter"}),l||Te.push({role:"system",content:w,identifier:"charDescription"},{role:"system",content:we,identifier:"charPersonality"},{role:"system",content:Ee,identifier:"scenario"}),Te.push({role:"system",content:xe,identifier:"impersonate"},{role:"system",content:Se,identifier:"groupNudge"});const Ce=p.extensionPrompts["1_memory"];Ce&&Ce.value&&Te.push({role:P(Ce.role),content:Ce.value,identifier:"summary",position:D(Ce.position)});const Pe=p.extensionPrompts["2_floating_prompt"];!c&&Pe&&Pe.value&&Te.push({role:P(Pe.role),content:Pe.value,identifier:"authorsNote",position:D(Pe.position)});const Ae=p.extensionPrompts["3_vectors"];Ae&&Ae.value&&Te.push({role:"system",content:Ae.value,identifier:"vectorsMemory",position:D(Ae.position)});const De=p.extensionPrompts["4_vectors_data_bank"];De&&De.value&&Te.push({role:P(De.role),content:De.value,identifier:"vectorsDataBank",position:D(De.position)});const Oe=p.extensionPrompts.chromadb;function Re(e){const t=Te.find((t=>t.identifier===e));if(t)return t;const n=ye.prompts.find((t=>t.identifier===e));return n||void 0}Oe&&Oe.value&&Te.push({role:"system",content:Oe.value,identifier:"smartContext",position:D(Oe.position)}),!l&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===f.persona_description_positions.IN_PROMPT&&Te.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),be.order.forEach((e=>{if(!e.enabled)return;const t=Re(e.identifier);t&&t.content?$.add({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&ee()}))}var te,ne,oe;const re=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ie in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Ie)){const Ne=p.extensionPrompts[Ie];if(re.includes(Ie))continue;if(!p.extensionPrompts[Ie].value)continue;if(![h.extension_prompt_types.BEFORE_PROMPT,h.extension_prompt_types.IN_PROMPT].includes(Ne.position))continue;if("function"==typeof Ne.filter&&!await Ne.filter())continue;const Me={role:P(Ne.role)??"system",content:Ne.value};if(Ne.position===h.extension_prompt_types.BEFORE_PROMPT)$.insert(Ne.depth,Me);else if(Ne.position===h.extension_prompt_types.IN_PROMPT){const ke=$.getMessages();$.insert(ke.length-Ne.depth,Me)}}for(const Le of Q){const Fe=$.getMessages();$.insert(Fe.length-Le.depth,{role:P(Le.role),content:Le.entries.join("\n")})}if(!l){const Be=(ie=b.selected_group,ae=Number(h.this_chid),(0,b.getGroupDepthPrompts)(ie,ae));if(b.selected_group&&Array.isArray(Be)&&Be.length>0)Be.filter((e=>e.text)).forEach(((e,t)=>{const n=$.getMessages();$.insert(n.length-e.depth,{role:e.role,content:e.text})}));else{const Ge=C(p.characters[h.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),h.name1,h.name2)||"";if(Ge){const je=h.depth_prompt_depth_default,$e=p.characters[h.this_chid]?.data?.extensions?.depth_prompt?.role??h.depth_prompt_role_default,He=$.getMessages();$.insert(He.length-je,{role:P($e),content:Ge})}}}var ie,ae;let se=-1;if(!c){const Ue={prompt:h.chat_metadata[y.metadata_keys.prompt],interval:h.chat_metadata[y.metadata_keys.interval],position:h.chat_metadata[y.metadata_keys.position],depth:h.chat_metadata[y.metadata_keys.depth],role:h.chat_metadata[y.metadata_keys.role]};if(Ue.prompt){Ue.prompt=C(Ue.prompt,h.name1,h.name2);const Ye={role:P(Ue.role),content:Ue.prompt};switch(Ue.position){case h.extension_prompt_types.IN_PROMPT:$.insert(1,Ye),se=1;break;case h.extension_prompt_types.IN_CHAT:se=$.getMessages().length-Ue.depth,$.insert(se,Ye);break;case h.extension_prompt_types.BEFORE_PROMPT:$.addFront(Ye),se=0}}}return se>=0&&(Z.length>0&&($.insert(se,{role:"system",content:Z.join("\n")}),se++),J.length>0&&$.insert(se+1,{role:"system",content:J.join("\n")})),{result:$.getMessages(),warnings:G}}
/**!
 * Sortable 1.15.6
 * @author	RubaXa   <trash@rubaxa.org>
 * @author	owenm    <owen23355@gmail.com>
 * @license MIT
 */
function M(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function k(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?M(Object(n),!0).forEach((function(t){F(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):M(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function L(e){return L="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},L(e)}function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function B(){return B=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},B.apply(this,arguments)}function G(e,t){if(null==e)return{};var n,o,r=function(e,t){if(null==e)return{};var n,o,r={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function j(e){if("undefined"!=typeof window&&window.navigator)return!!navigator.userAgent.match(e)}var H=j(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),U=j(/Edge/i),Y=j(/firefox/i),V=j(/safari/i)&&!j(/chrome/i)&&!j(/android/i),X=j(/iP(ad|od|hone)/i),q=j(/chrome/i)&&j(/android/i),W={capture:!1,passive:!1};function z(e,t,n){e.addEventListener(t,n,!H&&W)}function K(e,t,n){e.removeEventListener(t,n,!H&&W)}function Q(e,t){if(t){if(">"===t[0]&&(t=t.substring(1)),e)try{if(e.matches)return e.matches(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t)}catch(e){return!1}return!1}}function Z(e){return e.host&&e!==document&&e.host.nodeType?e.host:e.parentNode}function J(e,t,n,o){if(e){n=n||document;do{if(null!=t&&(">"===t[0]?e.parentNode===n&&Q(e,t):Q(e,t))||o&&e===n)return e;if(e===n)break}while(e=Z(e))}return null}var ee,te=/\s+/g;function ne(e,t,n){if(e&&t)if(e.classList)e.classList[n?"add":"remove"](t);else{var o=(" "+e.className+" ").replace(te," ").replace(" "+t+" "," ");e.className=(o+(n?" "+t:"")).replace(te," ")}}function oe(e,t,n){var o=e&&e.style;if(o){if(void 0===n)return document.defaultView&&document.defaultView.getComputedStyle?n=document.defaultView.getComputedStyle(e,""):e.currentStyle&&(n=e.currentStyle),void 0===t?n:n[t];t in o||-1!==t.indexOf("webkit")||(t="-webkit-"+t),o[t]=n+("string"==typeof n?"":"px")}}function re(e,t){var n="";if("string"==typeof e)n=e;else do{var o=oe(e,"transform");o&&"none"!==o&&(n=o+" "+n)}while(!t&&(e=e.parentNode));var r=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return r&&new r(n)}function ie(e,t,n){if(e){var o=e.getElementsByTagName(t),r=0,i=o.length;if(n)for(;r<i;r++)n(o[r],r);return o}return[]}function ae(){var e=document.scrollingElement;return e||document.documentElement}function se(e,t,n,o,r){if(e.getBoundingClientRect||e===window){var i,a,s,l,c,u,d;if(e!==window&&e.parentNode&&e!==ae()?(a=(i=e.getBoundingClientRect()).top,s=i.left,l=i.bottom,c=i.right,u=i.height,d=i.width):(a=0,s=0,l=window.innerHeight,c=window.innerWidth,u=window.innerHeight,d=window.innerWidth),(t||n)&&e!==window&&(r=r||e.parentNode,!H))do{if(r&&r.getBoundingClientRect&&("none"!==oe(r,"transform")||n&&"static"!==oe(r,"position"))){var p=r.getBoundingClientRect();a-=p.top+parseInt(oe(r,"border-top-width")),s-=p.left+parseInt(oe(r,"border-left-width")),l=a+i.height,c=s+i.width;break}}while(r=r.parentNode);if(o&&e!==window){var f=re(r||e),h=f&&f.a,m=f&&f.d;f&&(l=(a/=m)+(u/=m),c=(s/=h)+(d/=h))}return{top:a,left:s,bottom:l,right:c,width:d,height:u}}}function le(e,t,n){for(var o=fe(e,!0),r=se(e)[t];o;){var i=se(o)[n];if(!("top"===n||"left"===n?r>=i:r<=i))return o;if(o===ae())break;o=fe(o,!1)}return!1}function ce(e,t,n,o){for(var r=0,i=0,a=e.children;i<a.length;){if("none"!==a[i].style.display&&a[i]!==_t.ghost&&(o||a[i]!==_t.dragged)&&J(a[i],n.draggable,e,!1)){if(r===t)return a[i];r++}i++}return null}function ue(e,t){for(var n=e.lastElementChild;n&&(n===_t.ghost||"none"===oe(n,"display")||t&&!Q(n,t));)n=n.previousElementSibling;return n||null}function de(e,t){var n=0;if(!e||!e.parentNode)return-1;for(;e=e.previousElementSibling;)"TEMPLATE"===e.nodeName.toUpperCase()||e===_t.clone||t&&!Q(e,t)||n++;return n}function pe(e){var t=0,n=0,o=ae();if(e)do{var r=re(e),i=r.a,a=r.d;t+=e.scrollLeft*i,n+=e.scrollTop*a}while(e!==o&&(e=e.parentNode));return[t,n]}function fe(e,t){if(!e||!e.getBoundingClientRect)return ae();var n=e,o=!1;do{if(n.clientWidth<n.scrollWidth||n.clientHeight<n.scrollHeight){var r=oe(n);if(n.clientWidth<n.scrollWidth&&("auto"==r.overflowX||"scroll"==r.overflowX)||n.clientHeight<n.scrollHeight&&("auto"==r.overflowY||"scroll"==r.overflowY)){if(!n.getBoundingClientRect||n===document.body)return ae();if(o||t)return n;o=!0}}}while(n=n.parentNode);return ae()}function he(e,t){return Math.round(e.top)===Math.round(t.top)&&Math.round(e.left)===Math.round(t.left)&&Math.round(e.height)===Math.round(t.height)&&Math.round(e.width)===Math.round(t.width)}function me(e,t){return function(){if(!ee){var n=arguments;1===n.length?e.call(this,n[0]):e.apply(this,n),ee=setTimeout((function(){ee=void 0}),t)}}}function ge(e,t,n){e.scrollLeft+=t,e.scrollTop+=n}function ve(e){var t=window.Polymer,n=window.jQuery||window.Zepto;return t&&t.dom?t.dom(e).cloneNode(!0):n?n(e).clone(!0)[0]:e.cloneNode(!0)}function _e(e,t,n){var o={};return Array.from(e.children).forEach((function(r){var i,a,s,l;if(J(r,t.draggable,e,!1)&&!r.animated&&r!==n){var c=se(r);o.left=Math.min(null!==(i=o.left)&&void 0!==i?i:1/0,c.left),o.top=Math.min(null!==(a=o.top)&&void 0!==a?a:1/0,c.top),o.right=Math.max(null!==(s=o.right)&&void 0!==s?s:-1/0,c.right),o.bottom=Math.max(null!==(l=o.bottom)&&void 0!==l?l:-1/0,c.bottom)}})),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var ye="Sortable"+(new Date).getTime();function be(){var e,t=[];return{captureAnimationState:function(){(t=[],this.options.animation)&&[].slice.call(this.el.children).forEach((function(e){if("none"!==oe(e,"display")&&e!==_t.ghost){t.push({target:e,rect:se(e)});var n=k({},t[t.length-1].rect);if(e.thisAnimationDuration){var o=re(e,!0);o&&(n.top-=o.f,n.left-=o.e)}e.fromRect=n}}))},addAnimationState:function(e){t.push(e)},removeAnimationState:function(e){t.splice(function(e,t){for(var n in e)if(e.hasOwnProperty(n))for(var o in t)if(t.hasOwnProperty(o)&&t[o]===e[n][o])return Number(n);return-1}(t,{target:e}),1)},animateAll:function(n){var o=this;if(!this.options.animation)return clearTimeout(e),void("function"==typeof n&&n());var r=!1,i=0;t.forEach((function(e){var t=0,n=e.target,a=n.fromRect,s=se(n),l=n.prevFromRect,c=n.prevToRect,u=e.rect,d=re(n,!0);d&&(s.top-=d.f,s.left-=d.e),n.toRect=s,n.thisAnimationDuration&&he(l,s)&&!he(a,s)&&(u.top-s.top)/(u.left-s.left)==(a.top-s.top)/(a.left-s.left)&&(t=function(e,t,n,o){return Math.sqrt(Math.pow(t.top-e.top,2)+Math.pow(t.left-e.left,2))/Math.sqrt(Math.pow(t.top-n.top,2)+Math.pow(t.left-n.left,2))*o.animation}(u,l,c,o.options)),he(s,a)||(n.prevFromRect=a,n.prevToRect=s,t||(t=o.options.animation),o.animate(n,u,s,t)),t&&(r=!0,i=Math.max(i,t),clearTimeout(n.animationResetTimer),n.animationResetTimer=setTimeout((function(){n.animationTime=0,n.prevFromRect=null,n.fromRect=null,n.prevToRect=null,n.thisAnimationDuration=null}),t),n.thisAnimationDuration=t)})),clearTimeout(e),r?e=setTimeout((function(){"function"==typeof n&&n()}),i):"function"==typeof n&&n(),t=[]},animate:function(e,t,n,o){if(o){oe(e,"transition",""),oe(e,"transform","");var r=re(this.el),i=r&&r.a,a=r&&r.d,s=(t.left-n.left)/(i||1),l=(t.top-n.top)/(a||1);e.animatingX=!!s,e.animatingY=!!l,oe(e,"transform","translate3d("+s+"px,"+l+"px,0)"),this.forRepaintDummy=function(e){return e.offsetWidth}(e),oe(e,"transition","transform "+o+"ms"+(this.options.easing?" "+this.options.easing:"")),oe(e,"transform","translate3d(0,0,0)"),"number"==typeof e.animated&&clearTimeout(e.animated),e.animated=setTimeout((function(){oe(e,"transition",""),oe(e,"transform",""),e.animated=!1,e.animatingX=!1,e.animatingY=!1}),o)}}}}var Ee=[],we={initializeByDefault:!0},Se={mount:function(e){for(var t in we)we.hasOwnProperty(t)&&!(t in e)&&(e[t]=we[t]);Ee.forEach((function(t){if(t.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")})),Ee.push(e)},pluginEvent:function(e,t,n){var o=this;this.eventCanceled=!1,n.cancel=function(){o.eventCanceled=!0};var r=e+"Global";Ee.forEach((function(o){t[o.pluginName]&&(t[o.pluginName][r]&&t[o.pluginName][r](k({sortable:t},n)),t.options[o.pluginName]&&t[o.pluginName][e]&&t[o.pluginName][e](k({sortable:t},n)))}))},initializePlugins:function(e,t,n,o){for(var r in Ee.forEach((function(o){var r=o.pluginName;if(e.options[r]||o.initializeByDefault){var i=new o(e,t,e.options);i.sortable=e,i.options=e.options,e[r]=i,B(n,i.defaults)}})),e.options)if(e.options.hasOwnProperty(r)){var i=this.modifyOption(e,r,e.options[r]);void 0!==i&&(e.options[r]=i)}},getEventProperties:function(e,t){var n={};return Ee.forEach((function(o){"function"==typeof o.eventProperties&&B(n,o.eventProperties.call(t[o.pluginName],e))})),n},modifyOption:function(e,t,n){var o;return Ee.forEach((function(r){e[r.pluginName]&&r.optionListeners&&"function"==typeof r.optionListeners[t]&&(o=r.optionListeners[t].call(e[r.pluginName],n))})),o}};function xe(e){var t=e.sortable,n=e.rootEl,o=e.name,r=e.targetEl,i=e.cloneEl,a=e.toEl,s=e.fromEl,l=e.oldIndex,c=e.newIndex,u=e.oldDraggableIndex,d=e.newDraggableIndex,p=e.originalEvent,f=e.putSortable,h=e.extraEventProperties;if(t=t||n&&n[ye]){var m,g=t.options,v="on"+o.charAt(0).toUpperCase()+o.substr(1);!window.CustomEvent||H||U?(m=document.createEvent("Event")).initEvent(o,!0,!0):m=new CustomEvent(o,{bubbles:!0,cancelable:!0}),m.to=a||n,m.from=s||n,m.item=r||n,m.clone=i,m.oldIndex=l,m.newIndex=c,m.oldDraggableIndex=u,m.newDraggableIndex=d,m.originalEvent=p,m.pullMode=f?f.lastPutMode:void 0;var _=k(k({},h),Se.getEventProperties(o,t));for(var y in _)m[y]=_[y];n&&n.dispatchEvent(m),g[v]&&g[v].call(t,m)}}var Te=["evt"],Ce=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.evt,r=G(n,Te);Se.pluginEvent.bind(_t)(e,t,k({dragEl:Ae,parentEl:De,ghostEl:Oe,rootEl:Re,nextEl:Ie,lastDownEl:Ne,cloneEl:Me,cloneHidden:ke,dragStarted:We,putSortable:$e,activeSortable:_t.active,originalEvent:o,oldIndex:Le,oldDraggableIndex:Be,newIndex:Fe,newDraggableIndex:Ge,hideGhostForTarget:ht,unhideGhostForTarget:mt,cloneNowHidden:function(){ke=!0},cloneNowShown:function(){ke=!1},dispatchSortableEvent:function(e){Pe({sortable:t,name:e,originalEvent:o})}},r))};function Pe(e){xe(k({putSortable:$e,cloneEl:Me,targetEl:Ae,rootEl:Re,oldIndex:Le,oldDraggableIndex:Be,newIndex:Fe,newDraggableIndex:Ge},e))}var Ae,De,Oe,Re,Ie,Ne,Me,ke,Le,Fe,Be,Ge,je,$e,He,Ue,Ye,Ve,Xe,qe,We,ze,Ke,Qe,Ze,Je=!1,et=!1,tt=[],nt=!1,ot=!1,rt=[],it=!1,at=[],st="undefined"!=typeof document,lt=X,ct=U||H?"cssFloat":"float",ut=st&&!q&&!X&&"draggable"in document.createElement("div"),dt=function(){if(st){if(H)return!1;var e=document.createElement("x");return e.style.cssText="pointer-events:auto","auto"===e.style.pointerEvents}}(),pt=function(e,t){var n=oe(e),o=parseInt(n.width)-parseInt(n.paddingLeft)-parseInt(n.paddingRight)-parseInt(n.borderLeftWidth)-parseInt(n.borderRightWidth),r=ce(e,0,t),i=ce(e,1,t),a=r&&oe(r),s=i&&oe(i),l=a&&parseInt(a.marginLeft)+parseInt(a.marginRight)+se(r).width,c=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+se(i).width;if("flex"===n.display)return"column"===n.flexDirection||"column-reverse"===n.flexDirection?"vertical":"horizontal";if("grid"===n.display)return n.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(r&&a.float&&"none"!==a.float){var u="left"===a.float?"left":"right";return!i||"both"!==s.clear&&s.clear!==u?"horizontal":"vertical"}return r&&("block"===a.display||"flex"===a.display||"table"===a.display||"grid"===a.display||l>=o&&"none"===n[ct]||i&&"none"===n[ct]&&l+c>o)?"vertical":"horizontal"},ft=function(e){function t(e,n){return function(o,r,i,a){var s=o.options.group.name&&r.options.group.name&&o.options.group.name===r.options.group.name;if(null==e&&(n||s))return!0;if(null==e||!1===e)return!1;if(n&&"clone"===e)return e;if("function"==typeof e)return t(e(o,r,i,a),n)(o,r,i,a);var l=(n?o:r).options.group.name;return!0===e||"string"==typeof e&&e===l||e.join&&e.indexOf(l)>-1}}var n={},o=e.group;o&&"object"==L(o)||(o={name:o}),n.name=o.name,n.checkPull=t(o.pull,!0),n.checkPut=t(o.put),n.revertClone=o.revertClone,e.group=n},ht=function(){!dt&&Oe&&oe(Oe,"display","none")},mt=function(){!dt&&Oe&&oe(Oe,"display","")};st&&!q&&document.addEventListener("click",(function(e){if(et)return e.preventDefault(),e.stopPropagation&&e.stopPropagation(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),et=!1,!1}),!0);var gt=function(e){if(Ae){var t=function(e,t){var n;return tt.some((function(o){var r=o[ye].options.emptyInsertThreshold;if(r&&!ue(o)){var i=se(o),a=e>=i.left-r&&e<=i.right+r,s=t>=i.top-r&&t<=i.bottom+r;return a&&s?n=o:void 0}})),n}((e=e.touches?e.touches[0]:e).clientX,e.clientY);if(t){var n={};for(var o in e)e.hasOwnProperty(o)&&(n[o]=e[o]);n.target=n.rootEl=t,n.preventDefault=void 0,n.stopPropagation=void 0,t[ye]._onDragOver(n)}}},vt=function(e){Ae&&Ae.parentNode[ye]._isOutsideThisEl(e.target)};function _t(e,t){if(!e||!e.nodeType||1!==e.nodeType)throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(e));this.el=e,this.options=t=B({},t),e[ye]=this;var n={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(e.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return pt(e,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(e,t){e.setData("Text",t.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:!1!==_t.supportPointer&&"PointerEvent"in window&&(!V||X),emptyInsertThreshold:5};for(var o in Se.initializePlugins(this,e,n),n)!(o in t)&&(t[o]=n[o]);for(var r in ft(t),this)"_"===r.charAt(0)&&"function"==typeof this[r]&&(this[r]=this[r].bind(this));this.nativeDraggable=!t.forceFallback&&ut,this.nativeDraggable&&(this.options.touchStartThreshold=1),t.supportPointer?z(e,"pointerdown",this._onTapStart):(z(e,"mousedown",this._onTapStart),z(e,"touchstart",this._onTapStart)),this.nativeDraggable&&(z(e,"dragover",this),z(e,"dragenter",this)),tt.push(this.el),t.store&&t.store.get&&this.sort(t.store.get(this)||[]),B(this,be())}function yt(e,t,n,o,r,i,a,s){var l,c,u=e[ye],d=u.options.onMove;return!window.CustomEvent||H||U?(l=document.createEvent("Event")).initEvent("move",!0,!0):l=new CustomEvent("move",{bubbles:!0,cancelable:!0}),l.to=t,l.from=e,l.dragged=n,l.draggedRect=o,l.related=r||t,l.relatedRect=i||se(t),l.willInsertAfter=s,l.originalEvent=a,e.dispatchEvent(l),d&&(c=d.call(u,l,a)),c}function bt(e){e.draggable=!1}function Et(){it=!1}function wt(e){for(var t=e.tagName+e.className+e.src+e.href+e.textContent,n=t.length,o=0;n--;)o+=t.charCodeAt(n);return o.toString(36)}function St(e){return setTimeout(e,0)}function xt(e){return clearTimeout(e)}_t.prototype={constructor:_t,_isOutsideThisEl:function(e){this.el.contains(e)||e===this.el||(ze=null)},_getDirection:function(e,t){return"function"==typeof this.options.direction?this.options.direction.call(this,e,t,Ae):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,n=this.el,o=this.options,r=o.preventOnFilter,i=e.type,a=e.touches&&e.touches[0]||e.pointerType&&"touch"===e.pointerType&&e,s=(a||e).target,l=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||s,c=o.filter;if(function(e){at.length=0;var t=e.getElementsByTagName("input"),n=t.length;for(;n--;){var o=t[n];o.checked&&at.push(o)}}(n),!Ae&&!(/mousedown|pointerdown/.test(i)&&0!==e.button||o.disabled)&&!l.isContentEditable&&(this.nativeDraggable||!V||!s||"SELECT"!==s.tagName.toUpperCase())&&!((s=J(s,o.draggable,n,!1))&&s.animated||Ne===s)){if(Le=de(s),Be=de(s,o.draggable),"function"==typeof c){if(c.call(this,e,s,this))return Pe({sortable:t,rootEl:l,name:"filter",targetEl:s,toEl:n,fromEl:n}),Ce("filter",t,{evt:e}),void(r&&e.preventDefault())}else if(c&&(c=c.split(",").some((function(o){if(o=J(l,o.trim(),n,!1))return Pe({sortable:t,rootEl:o,name:"filter",targetEl:s,fromEl:n,toEl:n}),Ce("filter",t,{evt:e}),!0}))))return void(r&&e.preventDefault());o.handle&&!J(l,o.handle,n,!1)||this._prepareDragStart(e,a,s)}}},_prepareDragStart:function(e,t,n){var o,r=this,i=r.el,a=r.options,s=i.ownerDocument;if(n&&!Ae&&n.parentNode===i){var l=se(n);if(Re=i,De=(Ae=n).parentNode,Ie=Ae.nextSibling,Ne=n,je=a.group,_t.dragged=Ae,He={target:Ae,clientX:(t||e).clientX,clientY:(t||e).clientY},Xe=He.clientX-l.left,qe=He.clientY-l.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,Ae.style["will-change"]="all",o=function(){Ce("delayEnded",r,{evt:e}),_t.eventCanceled?r._onDrop():(r._disableDelayedDragEvents(),!Y&&r.nativeDraggable&&(Ae.draggable=!0),r._triggerDragStart(e,t),Pe({sortable:r,name:"choose",originalEvent:e}),ne(Ae,a.chosenClass,!0))},a.ignore.split(",").forEach((function(e){ie(Ae,e.trim(),bt)})),z(s,"dragover",gt),z(s,"mousemove",gt),z(s,"touchmove",gt),a.supportPointer?(z(s,"pointerup",r._onDrop),!this.nativeDraggable&&z(s,"pointercancel",r._onDrop)):(z(s,"mouseup",r._onDrop),z(s,"touchend",r._onDrop),z(s,"touchcancel",r._onDrop)),Y&&this.nativeDraggable&&(this.options.touchStartThreshold=4,Ae.draggable=!0),Ce("delayStart",this,{evt:e}),!a.delay||a.delayOnTouchOnly&&!t||this.nativeDraggable&&(U||H))o();else{if(_t.eventCanceled)return void this._onDrop();a.supportPointer?(z(s,"pointerup",r._disableDelayedDrag),z(s,"pointercancel",r._disableDelayedDrag)):(z(s,"mouseup",r._disableDelayedDrag),z(s,"touchend",r._disableDelayedDrag),z(s,"touchcancel",r._disableDelayedDrag)),z(s,"mousemove",r._delayedDragTouchMoveHandler),z(s,"touchmove",r._delayedDragTouchMoveHandler),a.supportPointer&&z(s,"pointermove",r._delayedDragTouchMoveHandler),r._dragStartTimer=setTimeout(o,a.delay)}}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){Ae&&bt(Ae),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;K(e,"mouseup",this._disableDelayedDrag),K(e,"touchend",this._disableDelayedDrag),K(e,"touchcancel",this._disableDelayedDrag),K(e,"pointerup",this._disableDelayedDrag),K(e,"pointercancel",this._disableDelayedDrag),K(e,"mousemove",this._delayedDragTouchMoveHandler),K(e,"touchmove",this._delayedDragTouchMoveHandler),K(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||"touch"==e.pointerType&&e,!this.nativeDraggable||t?this.options.supportPointer?z(document,"pointermove",this._onTouchMove):z(document,t?"touchmove":"mousemove",this._onTouchMove):(z(Ae,"dragend",this),z(Re,"dragstart",this._onDragStart));try{document.selection?St((function(){document.selection.empty()})):window.getSelection().removeAllRanges()}catch(e){}},_dragStarted:function(e,t){if(Je=!1,Re&&Ae){Ce("dragStarted",this,{evt:t}),this.nativeDraggable&&z(document,"dragover",vt);var n=this.options;!e&&ne(Ae,n.dragClass,!1),ne(Ae,n.ghostClass,!0),_t.active=this,e&&this._appendGhost(),Pe({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Ue){this._lastX=Ue.clientX,this._lastY=Ue.clientY,ht();for(var e=document.elementFromPoint(Ue.clientX,Ue.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Ue.clientX,Ue.clientY))!==t;)t=e;if(Ae.parentNode[ye]._isOutsideThisEl(e),t)do{if(t[ye]){if(t[ye]._onDragOver({clientX:Ue.clientX,clientY:Ue.clientY,target:e,rootEl:t})&&!this.options.dragoverBubble)break}e=t}while(t=Z(t));mt()}},_onTouchMove:function(e){if(He){var t=this.options,n=t.fallbackTolerance,o=t.fallbackOffset,r=e.touches?e.touches[0]:e,i=Oe&&re(Oe,!0),a=Oe&&i&&i.a,s=Oe&&i&&i.d,l=lt&&Ze&&pe(Ze),c=(r.clientX-He.clientX+o.x)/(a||1)+(l?l[0]-rt[0]:0)/(a||1),u=(r.clientY-He.clientY+o.y)/(s||1)+(l?l[1]-rt[1]:0)/(s||1);if(!_t.active&&!Je){if(n&&Math.max(Math.abs(r.clientX-this._lastX),Math.abs(r.clientY-this._lastY))<n)return;this._onDragStart(e,!0)}if(Oe){i?(i.e+=c-(Ye||0),i.f+=u-(Ve||0)):i={a:1,b:0,c:0,d:1,e:c,f:u};var d="matrix(".concat(i.a,",").concat(i.b,",").concat(i.c,",").concat(i.d,",").concat(i.e,",").concat(i.f,")");oe(Oe,"webkitTransform",d),oe(Oe,"mozTransform",d),oe(Oe,"msTransform",d),oe(Oe,"transform",d),Ye=c,Ve=u,Ue=r}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!Oe){var e=this.options.fallbackOnBody?document.body:Re,t=se(Ae,!0,lt,!0,e),n=this.options;if(lt){for(Ze=e;"static"===oe(Ze,"position")&&"none"===oe(Ze,"transform")&&Ze!==document;)Ze=Ze.parentNode;Ze!==document.body&&Ze!==document.documentElement?(Ze===document&&(Ze=ae()),t.top+=Ze.scrollTop,t.left+=Ze.scrollLeft):Ze=ae(),rt=pe(Ze)}ne(Oe=Ae.cloneNode(!0),n.ghostClass,!1),ne(Oe,n.fallbackClass,!0),ne(Oe,n.dragClass,!0),oe(Oe,"transition",""),oe(Oe,"transform",""),oe(Oe,"box-sizing","border-box"),oe(Oe,"margin",0),oe(Oe,"top",t.top),oe(Oe,"left",t.left),oe(Oe,"width",t.width),oe(Oe,"height",t.height),oe(Oe,"opacity","0.8"),oe(Oe,"position",lt?"absolute":"fixed"),oe(Oe,"zIndex","100000"),oe(Oe,"pointerEvents","none"),_t.ghost=Oe,e.appendChild(Oe),oe(Oe,"transform-origin",Xe/parseInt(Oe.style.width)*100+"% "+qe/parseInt(Oe.style.height)*100+"%")}},_onDragStart:function(e,t){var n=this,o=e.dataTransfer,r=n.options;Ce("dragStart",this,{evt:e}),_t.eventCanceled?this._onDrop():(Ce("setupClone",this),_t.eventCanceled||((Me=ve(Ae)).removeAttribute("id"),Me.draggable=!1,Me.style["will-change"]="",this._hideClone(),ne(Me,this.options.chosenClass,!1),_t.clone=Me),n.cloneId=St((function(){Ce("clone",n),_t.eventCanceled||(n.options.removeCloneOnHide||Re.insertBefore(Me,Ae),n._hideClone(),Pe({sortable:n,name:"clone"}))})),!t&&ne(Ae,r.dragClass,!0),t?(et=!0,n._loopId=setInterval(n._emulateDragOver,50)):(K(document,"mouseup",n._onDrop),K(document,"touchend",n._onDrop),K(document,"touchcancel",n._onDrop),o&&(o.effectAllowed="move",r.setData&&r.setData.call(n,o,Ae)),z(document,"drop",n),oe(Ae,"transform","translateZ(0)")),Je=!0,n._dragStartId=St(n._dragStarted.bind(n,t,e)),z(document,"selectstart",n),We=!0,window.getSelection().removeAllRanges(),V&&oe(document.body,"user-select","none"))},_onDragOver:function(e){var t,n,o,r,i=this.el,a=e.target,s=this.options,l=s.group,c=_t.active,u=je===l,d=s.sort,p=$e||c,f=this,h=!1;if(!it){if(void 0!==e.preventDefault&&e.cancelable&&e.preventDefault(),a=J(a,s.draggable,i,!0),D("dragOver"),_t.eventCanceled)return h;if(Ae.contains(e.target)||a.animated&&a.animatingX&&a.animatingY||f._ignoreWhileAnimating===a)return R(!1);if(et=!1,c&&!s.disabled&&(u?d||(o=De!==Re):$e===this||(this.lastPutMode=je.checkPull(this,c,Ae,e))&&l.checkPut(this,c,Ae,e))){if(r="vertical"===this._getDirection(e,a),t=se(Ae),D("dragOverValid"),_t.eventCanceled)return h;if(o)return De=Re,O(),this._hideClone(),D("revert"),_t.eventCanceled||(Ie?Re.insertBefore(Ae,Ie):Re.appendChild(Ae)),R(!0);var m=ue(i,s.draggable);if(!m||function(e,t,n){var o=se(ue(n.el,n.options.draggable)),r=_e(n.el,n.options,Oe),i=10;return t?e.clientX>r.right+i||e.clientY>o.bottom&&e.clientX>o.left:e.clientY>r.bottom+i||e.clientX>o.right&&e.clientY>o.top}(e,r,this)&&!m.animated){if(m===Ae)return R(!1);if(m&&i===e.target&&(a=m),a&&(n=se(a)),!1!==yt(Re,i,Ae,t,a,n,e,!!a))return O(),m&&m.nextSibling?i.insertBefore(Ae,m.nextSibling):i.appendChild(Ae),De=i,I(),R(!0)}else if(m&&function(e,t,n){var o=se(ce(n.el,0,n.options,!0)),r=_e(n.el,n.options,Oe),i=10;return t?e.clientX<r.left-i||e.clientY<o.top&&e.clientX<o.right:e.clientY<r.top-i||e.clientY<o.bottom&&e.clientX<o.left}(e,r,this)){var g=ce(i,0,s,!0);if(g===Ae)return R(!1);if(n=se(a=g),!1!==yt(Re,i,Ae,t,a,n,e,!1))return O(),i.insertBefore(Ae,g),De=i,I(),R(!0)}else if(a.parentNode===i){n=se(a);var v,_,y,b=Ae.parentNode!==i,E=!function(e,t,n){var o=n?e.left:e.top,r=n?e.right:e.bottom,i=n?e.width:e.height,a=n?t.left:t.top,s=n?t.right:t.bottom,l=n?t.width:t.height;return o===a||r===s||o+i/2===a+l/2}(Ae.animated&&Ae.toRect||t,a.animated&&a.toRect||n,r),w=r?"top":"left",S=le(a,"top","top")||le(Ae,"top","top"),x=S?S.scrollTop:void 0;if(ze!==a&&(_=n[w],nt=!1,ot=!E&&s.invertSwap||b),v=function(e,t,n,o,r,i,a,s){var l=o?e.clientY:e.clientX,c=o?n.height:n.width,u=o?n.top:n.left,d=o?n.bottom:n.right,p=!1;if(!a)if(s&&Qe<c*r){if(!nt&&(1===Ke?l>u+c*i/2:l<d-c*i/2)&&(nt=!0),nt)p=!0;else if(1===Ke?l<u+Qe:l>d-Qe)return-Ke}else if(l>u+c*(1-r)/2&&l<d-c*(1-r)/2)return function(e){return de(Ae)<de(e)?1:-1}(t);if((p=p||a)&&(l<u+c*i/2||l>d-c*i/2))return l>u+c/2?1:-1;return 0}(e,a,n,r,E?1:s.swapThreshold,null==s.invertedSwapThreshold?s.swapThreshold:s.invertedSwapThreshold,ot,ze===a),0!==v){var T=de(Ae);do{T-=v,y=De.children[T]}while(y&&("none"===oe(y,"display")||y===Oe))}if(0===v||y===a)return R(!1);ze=a,Ke=v;var C=a.nextElementSibling,P=!1,A=yt(Re,i,Ae,t,a,n,e,P=1===v);if(!1!==A)return 1!==A&&-1!==A||(P=1===A),it=!0,setTimeout(Et,30),O(),P&&!C?i.appendChild(Ae):a.parentNode.insertBefore(Ae,P?C:a),S&&ge(S,0,x-S.scrollTop),De=Ae.parentNode,void 0===_||ot||(Qe=Math.abs(_-se(a)[w])),I(),R(!0)}if(i.contains(Ae))return R(!1)}return!1}function D(s,l){Ce(s,f,k({evt:e,isOwner:u,axis:r?"vertical":"horizontal",revert:o,dragRect:t,targetRect:n,canSort:d,fromSortable:p,target:a,completed:R,onMove:function(n,o){return yt(Re,i,Ae,t,n,se(n),e,o)},changed:I},l))}function O(){D("dragOverAnimationCapture"),f.captureAnimationState(),f!==p&&p.captureAnimationState()}function R(t){return D("dragOverCompleted",{insertion:t}),t&&(u?c._hideClone():c._showClone(f),f!==p&&(ne(Ae,$e?$e.options.ghostClass:c.options.ghostClass,!1),ne(Ae,s.ghostClass,!0)),$e!==f&&f!==_t.active?$e=f:f===_t.active&&$e&&($e=null),p===f&&(f._ignoreWhileAnimating=a),f.animateAll((function(){D("dragOverAnimationComplete"),f._ignoreWhileAnimating=null})),f!==p&&(p.animateAll(),p._ignoreWhileAnimating=null)),(a===Ae&&!Ae.animated||a===i&&!a.animated)&&(ze=null),s.dragoverBubble||e.rootEl||a===document||(Ae.parentNode[ye]._isOutsideThisEl(e.target),!t&&gt(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),h=!0}function I(){Fe=de(Ae),Ge=de(Ae,s.draggable),Pe({sortable:f,name:"change",toEl:i,newIndex:Fe,newDraggableIndex:Ge,originalEvent:e})}},_ignoreWhileAnimating:null,_offMoveEvents:function(){K(document,"mousemove",this._onTouchMove),K(document,"touchmove",this._onTouchMove),K(document,"pointermove",this._onTouchMove),K(document,"dragover",gt),K(document,"mousemove",gt),K(document,"touchmove",gt)},_offUpEvents:function(){var e=this.el.ownerDocument;K(e,"mouseup",this._onDrop),K(e,"touchend",this._onDrop),K(e,"pointerup",this._onDrop),K(e,"pointercancel",this._onDrop),K(e,"touchcancel",this._onDrop),K(document,"selectstart",this)},_onDrop:function(e){var t=this.el,n=this.options;Fe=de(Ae),Ge=de(Ae,n.draggable),Ce("drop",this,{evt:e}),De=Ae&&Ae.parentNode,Fe=de(Ae),Ge=de(Ae,n.draggable),_t.eventCanceled||(Je=!1,ot=!1,nt=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),xt(this.cloneId),xt(this._dragStartId),this.nativeDraggable&&(K(document,"drop",this),K(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),V&&oe(document.body,"user-select",""),oe(Ae,"transform",""),e&&(We&&(e.cancelable&&e.preventDefault(),!n.dropBubble&&e.stopPropagation()),Oe&&Oe.parentNode&&Oe.parentNode.removeChild(Oe),(Re===De||$e&&"clone"!==$e.lastPutMode)&&Me&&Me.parentNode&&Me.parentNode.removeChild(Me),Ae&&(this.nativeDraggable&&K(Ae,"dragend",this),bt(Ae),Ae.style["will-change"]="",We&&!Je&&ne(Ae,$e?$e.options.ghostClass:this.options.ghostClass,!1),ne(Ae,this.options.chosenClass,!1),Pe({sortable:this,name:"unchoose",toEl:De,newIndex:null,newDraggableIndex:null,originalEvent:e}),Re!==De?(Fe>=0&&(Pe({rootEl:De,name:"add",toEl:De,fromEl:Re,originalEvent:e}),Pe({sortable:this,name:"remove",toEl:De,originalEvent:e}),Pe({rootEl:De,name:"sort",toEl:De,fromEl:Re,originalEvent:e}),Pe({sortable:this,name:"sort",toEl:De,originalEvent:e})),$e&&$e.save()):Fe!==Le&&Fe>=0&&(Pe({sortable:this,name:"update",toEl:De,originalEvent:e}),Pe({sortable:this,name:"sort",toEl:De,originalEvent:e})),_t.active&&(null!=Fe&&-1!==Fe||(Fe=Le,Ge=Be),Pe({sortable:this,name:"end",toEl:De,originalEvent:e}),this.save())))),this._nulling()},_nulling:function(){Ce("nulling",this),Re=Ae=De=Oe=Ie=Me=Ne=ke=He=Ue=We=Fe=Ge=Le=Be=ze=Ke=$e=je=_t.dragged=_t.ghost=_t.clone=_t.active=null,at.forEach((function(e){e.checked=!0})),at.length=Ye=Ve=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":Ae&&(this._onDragOver(e),function(e){e.dataTransfer&&(e.dataTransfer.dropEffect="move");e.cancelable&&e.preventDefault()}(e));break;case"selectstart":e.preventDefault()}},toArray:function(){for(var e,t=[],n=this.el.children,o=0,r=n.length,i=this.options;o<r;o++)J(e=n[o],i.draggable,this.el,!1)&&t.push(e.getAttribute(i.dataIdAttr)||wt(e));return t},sort:function(e,t){var n={},o=this.el;this.toArray().forEach((function(e,t){var r=o.children[t];J(r,this.options.draggable,o,!1)&&(n[e]=r)}),this),t&&this.captureAnimationState(),e.forEach((function(e){n[e]&&(o.removeChild(n[e]),o.appendChild(n[e]))})),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return J(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var n=this.options;if(void 0===t)return n[e];var o=Se.modifyOption(this,e,t);n[e]=void 0!==o?o:t,"group"===e&&ft(n)},destroy:function(){Ce("destroy",this);var e=this.el;e[ye]=null,K(e,"mousedown",this._onTapStart),K(e,"touchstart",this._onTapStart),K(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(K(e,"dragover",this),K(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),(function(e){e.removeAttribute("draggable")})),this._onDrop(),this._disableDelayedDragEvents(),tt.splice(tt.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!ke){if(Ce("hideClone",this),_t.eventCanceled)return;oe(Me,"display","none"),this.options.removeCloneOnHide&&Me.parentNode&&Me.parentNode.removeChild(Me),ke=!0}},_showClone:function(e){if("clone"===e.lastPutMode){if(ke){if(Ce("showClone",this),_t.eventCanceled)return;Ae.parentNode!=Re||this.options.group.revertClone?Ie?Re.insertBefore(Me,Ie):Re.appendChild(Me):Re.insertBefore(Me,Ae),this.options.group.revertClone&&this.animate(Ae,Me),oe(Me,"display",""),ke=!1}}else this._hideClone()}},st&&z(document,"touchmove",(function(e){(_t.active||Je)&&e.cancelable&&e.preventDefault()})),_t.utils={on:z,off:K,css:oe,find:ie,is:function(e,t){return!!J(e,t,e,!1)},extend:function(e,t){if(e&&t)for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},throttle:me,closest:J,toggleClass:ne,clone:ve,index:de,nextTick:St,cancelNextTick:xt,detectDirection:pt,getChild:ce,expando:ye},_t.get=function(e){return e[ye]},_t.mount=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];t[0].constructor===Array&&(t=t[0]),t.forEach((function(e){if(!e.prototype||!e.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(e));e.utils&&(_t.utils=k(k({},_t.utils),e.utils)),Se.mount(e)}))},_t.create=function(e,t){return new _t(e,t)},_t.version="1.15.6";var Tt,Ct,Pt,At,Dt,Ot,Rt=[],It=!1;function Nt(){Rt.forEach((function(e){clearInterval(e.pid)})),Rt=[]}function Mt(){clearInterval(Ot)}var kt=me((function(e,t,n,o){if(t.scroll){var r,i=(e.touches?e.touches[0]:e).clientX,a=(e.touches?e.touches[0]:e).clientY,s=t.scrollSensitivity,l=t.scrollSpeed,c=ae(),u=!1;Ct!==n&&(Ct=n,Nt(),Tt=t.scroll,r=t.scrollFn,!0===Tt&&(Tt=fe(n,!0)));var d=0,p=Tt;do{var f=p,h=se(f),m=h.top,g=h.bottom,v=h.left,_=h.right,y=h.width,b=h.height,E=void 0,w=void 0,S=f.scrollWidth,x=f.scrollHeight,T=oe(f),C=f.scrollLeft,P=f.scrollTop;f===c?(E=y<S&&("auto"===T.overflowX||"scroll"===T.overflowX||"visible"===T.overflowX),w=b<x&&("auto"===T.overflowY||"scroll"===T.overflowY||"visible"===T.overflowY)):(E=y<S&&("auto"===T.overflowX||"scroll"===T.overflowX),w=b<x&&("auto"===T.overflowY||"scroll"===T.overflowY));var A=E&&(Math.abs(_-i)<=s&&C+y<S)-(Math.abs(v-i)<=s&&!!C),D=w&&(Math.abs(g-a)<=s&&P+b<x)-(Math.abs(m-a)<=s&&!!P);if(!Rt[d])for(var O=0;O<=d;O++)Rt[O]||(Rt[O]={});Rt[d].vx==A&&Rt[d].vy==D&&Rt[d].el===f||(Rt[d].el=f,Rt[d].vx=A,Rt[d].vy=D,clearInterval(Rt[d].pid),0==A&&0==D||(u=!0,Rt[d].pid=setInterval(function(){o&&0===this.layer&&_t.active._onTouchMove(Dt);var t=Rt[this.layer].vy?Rt[this.layer].vy*l:0,n=Rt[this.layer].vx?Rt[this.layer].vx*l:0;"function"==typeof r&&"continue"!==r.call(_t.dragged.parentNode[ye],n,t,e,Dt,Rt[this.layer].el)||ge(Rt[this.layer].el,n,t)}.bind({layer:d}),24))),d++}while(t.bubbleScroll&&p!==c&&(p=fe(p,!1)));It=u}}),30),Lt=function(e){var t=e.originalEvent,n=e.putSortable,o=e.dragEl,r=e.activeSortable,i=e.dispatchSortableEvent,a=e.hideGhostForTarget,s=e.unhideGhostForTarget;if(t){var l=n||r;a();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,u=document.elementFromPoint(c.clientX,c.clientY);s(),l&&!l.el.contains(u)&&(i("spill"),this.onSpill({dragEl:o,putSortable:n}))}};function Ft(){}function Bt(){}Ft.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,n=e.putSortable;this.sortable.captureAnimationState(),n&&n.captureAnimationState();var o=ce(this.sortable.el,this.startIndex,this.options);o?this.sortable.el.insertBefore(t,o):this.sortable.el.appendChild(t),this.sortable.animateAll(),n&&n.animateAll()},drop:Lt},B(Ft,{pluginName:"revertOnSpill"}),Bt.prototype={onSpill:function(e){var t=e.dragEl,n=e.putSortable||this.sortable;n.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),n.animateAll()},drop:Lt},B(Bt,{pluginName:"removeOnSpill"});_t.mount(new function(){function e(){for(var e in this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0},this)"_"===e.charAt(0)&&"function"==typeof this[e]&&(this[e]=this[e].bind(this))}return e.prototype={dragStarted:function(e){var t=e.originalEvent;this.sortable.nativeDraggable?z(document,"dragover",this._handleAutoScroll):this.options.supportPointer?z(document,"pointermove",this._handleFallbackAutoScroll):t.touches?z(document,"touchmove",this._handleFallbackAutoScroll):z(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(e){var t=e.originalEvent;this.options.dragOverBubble||t.rootEl||this._handleAutoScroll(t)},drop:function(){this.sortable.nativeDraggable?K(document,"dragover",this._handleAutoScroll):(K(document,"pointermove",this._handleFallbackAutoScroll),K(document,"touchmove",this._handleFallbackAutoScroll),K(document,"mousemove",this._handleFallbackAutoScroll)),Mt(),Nt(),clearTimeout(ee),ee=void 0},nulling:function(){Dt=Ct=Tt=It=Ot=Pt=At=null,Rt.length=0},_handleFallbackAutoScroll:function(e){this._handleAutoScroll(e,!0)},_handleAutoScroll:function(e,t){var n=this,o=(e.touches?e.touches[0]:e).clientX,r=(e.touches?e.touches[0]:e).clientY,i=document.elementFromPoint(o,r);if(Dt=e,t||this.options.forceAutoScrollFallback||U||H||V){kt(e,this.options,i,t);var a=fe(i,!0);!It||Ot&&o===Pt&&r===At||(Ot&&Mt(),Ot=setInterval((function(){var i=fe(document.elementFromPoint(o,r),!0);i!==a&&(a=i,Nt()),kt(e,n.options,i,t)}),10),Pt=o,At=r)}else{if(!this.options.bubbleScroll||fe(i,!0)===ae())return void Nt();kt(e,this.options,fe(i,!1),!1)}}},B(e,{pluginName:"scroll",initializeByDefault:!0})}),_t.mount(Bt,Ft);var Gt;function jt(e){return jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},jt(e)}function $t(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=jt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=jt(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==jt(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ht(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Ht=function(){return t};var e,t={},n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",l=i.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,o){var i=t&&t.prototype instanceof v?t:v,a=Object.create(i.prototype),s=new O(o||[]);return r(a,"_invoke",{value:C(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",f="suspendedYield",h="executing",m="completed",g={};function v(){}function _(){}function y(){}var b={};c(b,a,(function(){return this}));var E=Object.getPrototypeOf,w=E&&E(E(R([])));w&&w!==n&&o.call(w,a)&&(b=w);var S=y.prototype=v.prototype=Object.create(b);function x(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function n(r,i,a,s){var l=d(e[r],e,i);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==jt(u)&&o.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var i;r(this,"_invoke",{value:function(e,o){function r(){return new t((function(t,r){n(e,o,t,r)}))}return i=i?i.then(r,r):r()}})}function C(t,n,o){var r=p;return function(i,a){if(r===h)throw Error("Generator is already running");if(r===m){if("throw"===i)throw a;return{value:e,done:!0}}for(o.method=i,o.arg=a;;){var s=o.delegate;if(s){var l=P(s,o);if(l){if(l===g)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===p)throw r=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=h;var c=d(t,n,o);if("normal"===c.type){if(r=o.done?m:f,c.arg===g)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(r=m,o.method="throw",o.arg=c.arg)}}}function P(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),g;var i=d(r,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function D(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function R(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,i=function n(){for(;++r<t.length;)if(o.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(jt(t)+" is not iterable")}return _.prototype=y,r(S,"constructor",{value:y,configurable:!0}),r(y,"constructor",{value:_,configurable:!0}),_.displayName=c(y,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===_||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,c(e,l,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},x(T.prototype),c(T.prototype,s,(function(){return this})),t.AsyncIterator=T,t.async=function(e,n,o,r,i){void 0===i&&(i=Promise);var a=new T(u(e,n,o,r),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},x(S),c(S,l,"Generator"),c(S,a,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=R,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(D),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(o,r){return s.type="throw",s.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return r("end");if(a.tryLoc<=this.prev){var l=o.call(a,"catchLoc"),c=o.call(a,"finallyLoc");if(l&&c){if(this.prev<a.catchLoc)return r(a.catchLoc,!0);if(this.prev<a.finallyLoc)return r(a.finallyLoc)}else if(l){if(this.prev<a.catchLoc)return r(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return r(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),D(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var r=o.arg;D(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:R(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),g}},t}function Ut(e,t,n,o,r,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(o,r)}function Yt(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var i=e.apply(t,n);function a(e){Ut(i,o,r,a,s,"next",e)}function s(e){Ut(i,o,r,a,s,"throw",e)}a(void 0)}))}}!function(e){e.APP_READY="app_ready",e.EXTRAS_CONNECTED="extras_connected",e.MESSAGE_SWIPED="message_swiped",e.MESSAGE_SENT="message_sent",e.MESSAGE_RECEIVED="message_received",e.MESSAGE_EDITED="message_edited",e.MESSAGE_DELETED="message_deleted",e.MESSAGE_UPDATED="message_updated",e.MESSAGE_FILE_EMBEDDED="message_file_embedded",e.MORE_MESSAGES_LOADED="more_messages_loaded",e.IMPERSONATE_READY="impersonate_ready",e.CHAT_CHANGED="chat_id_changed",e.GENERATION_AFTER_COMMANDS="GENERATION_AFTER_COMMANDS",e.GENERATION_STARTED="generation_started",e.GENERATION_STOPPED="generation_stopped",e.GENERATION_ENDED="generation_ended",e.EXTENSIONS_FIRST_LOAD="extensions_first_load",e.EXTENSION_SETTINGS_LOADED="extension_settings_loaded",e.SETTINGS_LOADED="settings_loaded",e.SETTINGS_UPDATED="settings_updated",e.GROUP_UPDATED="group_updated",e.MOVABLE_PANELS_RESET="movable_panels_reset",e.SETTINGS_LOADED_BEFORE="settings_loaded_before",e.SETTINGS_LOADED_AFTER="settings_loaded_after",e.CHATCOMPLETION_SOURCE_CHANGED="chatcompletion_source_changed",e.CHATCOMPLETION_MODEL_CHANGED="chatcompletion_model_changed",e.OAI_PRESET_CHANGED_BEFORE="oai_preset_changed_before",e.OAI_PRESET_CHANGED_AFTER="oai_preset_changed_after",e.OAI_PRESET_EXPORT_READY="oai_preset_export_ready",e.OAI_PRESET_IMPORT_READY="oai_preset_import_ready",e.WORLDINFO_SETTINGS_UPDATED="worldinfo_settings_updated",e.WORLDINFO_UPDATED="worldinfo_updated",e.CHARACTER_EDITED="character_edited",e.CHARACTER_PAGE_LOADED="character_page_loaded",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE="character_group_overlay_state_change_before",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER="character_group_overlay_state_change_after",e.USER_MESSAGE_RENDERED="user_message_rendered",e.CHARACTER_MESSAGE_RENDERED="character_message_rendered",e.FORCE_SET_BACKGROUND="force_set_background",e.CHAT_DELETED="chat_deleted",e.CHAT_CREATED="chat_created",e.GROUP_CHAT_DELETED="group_chat_deleted",e.GROUP_CHAT_CREATED="group_chat_created",e.GENERATE_BEFORE_COMBINE_PROMPTS="generate_before_combine_prompts",e.GENERATE_AFTER_COMBINE_PROMPTS="generate_after_combine_prompts",e.GENERATE_AFTER_DATA="generate_after_data",e.GROUP_MEMBER_DRAFTED="group_member_drafted",e.GROUP_WRAPPER_STARTED="group_wrapper_started",e.GROUP_WRAPPER_FINISHED="group_wrapper_finished",e.WORLD_INFO_ACTIVATED="world_info_activated",e.TEXT_COMPLETION_SETTINGS_READY="text_completion_settings_ready",e.CHAT_COMPLETION_SETTINGS_READY="chat_completion_settings_ready",e.CHAT_COMPLETION_PROMPT_READY="chat_completion_prompt_ready",e.CHARACTER_FIRST_MESSAGE_SELECTED="character_first_message_selected",e.CHARACTER_DELETED="characterDeleted",e.CHARACTER_DUPLICATED="character_duplicated",e.CHARACTER_RENAMED="character_renamed",e.SMOOTH_STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_REASONING_DONE="stream_reasoning_done",e.FILE_ATTACHMENT_DELETED="file_attachment_deleted",e.WORLDINFO_FORCE_ACTIVATE="worldinfo_force_activate",e.OPEN_CHARACTER_LIBRARY="open_character_library",e.ONLINE_STATUS_CHANGED="online_status_changed",e.IMAGE_SWIPED="image_swiped",e.CONNECTION_PROFILE_LOADED="connection_profile_loaded",e.TOOL_CALLS_PERFORMED="tool_calls_performed",e.TOOL_CALLS_RENDERED="tool_calls_rendered"}(Gt||(Gt={}));var Vt=SillyTavern.getContext(),Xt="roadway",qt={TARGET:"roadway_target_chat",RAW_CONTENT:"roadway_raw_content",OPTIONS:"roadway_options"},Wt="Your task this time is to write your response as if you were {{user}}, impersonating their style. Use {{user}}'s dialogue and actions so far as a guideline for how they would likely act. Don't ever write as {{char}}. Only talk and act as {{user}}. This is what {{user}}'s focus:\n\n{{roadwaySelected}}",zt="You are an AI brainstorming partner, helping to create immersive and surprising roleplaying experiences, **building upon the established context from our previous conversation.** Your task is to generate an *unpredictable* and *engaging* list of options for **{{user}}**, specifically tailored to their character, the world, and the current situation as established in our previous dialogue. These should be framed as possible actions that **{{user}}** *could* take.\n\nOutput ONLY a numbered list of possible actions. Each action should be a clear, actionable, concise, and *creative* sentence written in plain text suggesting an action **{{user}}** can perform in the game.\n\nPrioritize *varied* actions that span multiple domains:\n\n{Observation/Investigation; Dialogue/Persuasion; Stealth/Intrigue; Combat/Conflict; Crafting/Repair; Knowledge/Lore; Movement/Traversal; Deception/Manipulation; Performance/Entertainment; Technical/Mechanical}.\n\nAvoid obvious or repetitive actions **that {{user}} has already explored or are contrary to the established character/world.** Push the boundaries of the situation. Challenge **{{user}}'s** expectations. Do not include greetings, farewells, polite thanks, or options that break character. Generate *exactly* 6 actions. The actions must be written in plain text.\n\nHere are a few example actions to inspire creativity:\n\n1. Attempt to communicate with the forest creatures to learn the location of hidden trails.\n2. Bribe the corrupt city guard with a song and a dance.\n3. Stage a fake ambush to draw out a hidden enemy.",Kt={version:"0.4.0",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:500,promptPreset:"default",autoTrigger:!1,autoOpen:!0,impersonateApi:"main",impersonateProfileId:"",showUseActionIcon:!0,autoSubmitUseAction:!1,messageRole:"system",promptPresets:{default:{content:zt,extractionStrategy:"bullet",impersonate:Wt}}},Qt=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,o=this.defaultSettings.formatVersion,r=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:o??""},oldSettings:null,newSettings:this.defaultSettings};if(!r)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const a={...i,oldSettings:structuredClone(r),version:{changed:!1,old:r.version,new:r.version},formatVersion:{changed:!1,old:r.formatVersion,new:r.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const o of Object.keys(t))void 0===e[o]?(e[o]=t[o],n=!0):"object"==typeof t[o]&&null!==t[o]&&(e[o]=e[o]||{},s(e[o],t[o])&&(n=!0));return n}n&&r.version!==n&&(a.version.changed=!0,a.version.new=n,r.version=n),o&&"*"!==o&&r.formatVersion!==o&&(a.formatVersion.changed=!0,a.formatVersion.new=o,r.formatVersion=o),(s(r,this.defaultSettings)||a.version.changed||a.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!r.version&&(r.version=n,a.version.changed=!0,a.version.new=n),o&&!r.formatVersion&&(r.formatVersion=o,a.formatVersion.changed=!0,a.formatVersion.new=o);let l=structuredClone(r),c=r.formatVersion;try{let u;do{u=!1;let d=t.find((e=>e.from===c));if(d&&d.to>c)l=await d.action(l),c=d.to,l.formatVersion=d.to,u=!0;else for(const p of t)if("*"===p.from&&p.to>c&&c!==p.to){l=await p.action(l),c=p.to,l.formatVersion=p.to,u=!0;break}}while(u);if(c!==r.formatVersion){a.formatVersion.changed=!0,a.formatVersion.new=c;const f=this.defaultSettings.version;f&&(l.version=f)}if(a.formatVersion.changed){for(const h of Object.keys(r))delete r[h];Object.assign(r,l),this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return a.newSettings=r,a}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}(Xt,Kt);function Zt(){return Zt=Yt(Ht().mark((function e(){var t,n,o,r,i,a,s,l,c,u,d,p,f,m,g,v,_,y,E,w,x,T,C,P,A,D;return Ht().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return D=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",o=document.createElement("details"),r=document.createElement("summary");if(r.textContent="Roadway",o.appendChild(r),null!=t&&t.length){var i=document.createElement("div");i.classList.add("".concat(n,"roadway_options")),t.forEach((function(e,t){var o=document.createElement("div");o.classList.add("".concat(n,"roadway_option"));var r=document.createElement("div");r.classList.add("".concat(n,"option_actions"));var a=document.createElement("div");a.classList.add("".concat(n,"action_button"),"".concat(n,"impersonate_action")),a.innerHTML="✍️",a.title="Impersonate";var s=document.createElement("div");s.classList.add("".concat(n,"action_button"),"".concat(n,"edit_action")),s.innerHTML="✏️",s.title="Edit";var l=Qt.getSettings(),c=document.createElement("div");c.classList.add("".concat(n,"action_button"),"".concat(n,"use_action")),c.innerHTML="▶️",c.title="Use option",c.style.display=l.showUseActionIcon?"inline-block":"none",r.appendChild(c),r.appendChild(a),r.appendChild(s);var u=document.createElement("div");u.classList.add("".concat(n,"option_content")),u.textContent=e,o.appendChild(r),o.appendChild(u),i.appendChild(o)})),o.appendChild(i)}else{var a=document.createElement("pre");a.classList.add("".concat(n,"roadway_pre")),a.textContent=e,o.appendChild(a)}return o.outerHTML},p=function(){var e,t=i.promptPresets[i.promptPreset];s.val(null==t?void 0:t.extractionStrategy);var n="none"===(null==t?void 0:t.extractionStrategy);l.toggle(!n),c.val(null!==(e=null==t?void 0:t.impersonate)&&void 0!==e?e:"")},e.next=4,Vt.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 4:o=e.sent,$("#extensions_settings").append(o),r=$(".roadway_settings"),i=Qt.getSettings(),Vt.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",i.profileId,(function(e){var t;i.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Qt.saveSettings()})),a=r.find("textarea.prompt"),s=r.find("select.extraction_strategy"),l=r.find(".impersonate_section"),c=r.find("textarea.impersonate"),u=O(".roadway_settings select.prompt",{initialValue:i.promptPreset,initialList:Object.keys(i.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=Yt(Ht().mark((function e(t,n){var o,r,u,d,p,f,h;return Ht().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:h=null!=n?n:"default",i.promptPreset=h,Qt.saveSettings(),a.val(null!==(o=null===(r=i.promptPresets[h])||void 0===r?void 0:r.content)&&void 0!==o?o:""),s.val(null===(u=i.promptPresets[h])||void 0===u?void 0:u.extractionStrategy),c.val(null!==(d=null===(p=i.promptPresets[h])||void 0===p?void 0:p.impersonate)&&void 0!==d?d:""),l.css("display","none"===(null===(f=i.promptPresets[h])||void 0===f?void 0:f.extractionStrategy)?"none":"block");case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n,o,r=i.promptPresets[i.promptPreset];i.promptPresets[e]={content:null!==(t=null==r?void 0:r.content)&&void 0!==t?t:zt,extractionStrategy:null!==(n=null==r?void 0:r.extractionStrategy)&&void 0!==n?n:"bullet",impersonate:null!==(o=null==r?void 0:r.impersonate)&&void 0!==o?o:Wt}}},rename:{onAfterRename:function(e,t){i.promptPresets[t]=i.promptPresets[e],delete i.promptPresets[e]}},delete:{onAfterDelete:function(e){delete i.promptPresets[e]}}}),d=u.select,a.val(null!==(t=null===(n=i.promptPresets[i.promptPreset])||void 0===n?void 0:n.content)&&void 0!==t?t:""),a.on("change",(function(){var e=a.val();i.promptPresets[i.promptPreset].content=e,Qt.saveSettings()})),p(),s.on("change",(function(){var e=$(this).val();i.promptPresets[i.promptPreset].extractionStrategy=e,Qt.saveSettings();var t="none"===e;l.toggle(!t)})),c.on("change",(function(){i.promptPresets[i.promptPreset].impersonate=$(this).val(),Qt.saveSettings()})),d.addEventListener("change",p),r.find(".restore_default").on("click",Yt(Ht().mark((function e(){return Ht().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Vt.Popup.show.confirm("Are you sure you want to restore the default prompt?","Restore default");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:i.promptPresets.default={content:zt,extractionStrategy:"bullet",impersonate:Wt},a.val(zt),s.val("bullet"),c.val(Wt),"default"!==d.value?(d.value="default",d.dispatchEvent(new Event("change"))):Qt.saveSettings();case 10:case"end":return e.stop()}}),e)})))),f=r.find(".max_context_type"),m=r.find(".max_context_value"),g=r.find(".max_context_custom"),f.val(i.maxContextType),m.val(i.maxContextValue),"custom"===i.maxContextType&&g.show(),f.on("change",(function(){var e=$(this).val();i.maxContextType=e,Qt.saveSettings(),g.toggle("custom"===e)})),m.on("change",(function(){i.maxContextValue=Number($(this).val()),Qt.saveSettings()})),(v=r.find(".max_response_tokens")).val(i.maxResponseToken),v.on("change",(function(){i.maxResponseToken=Number($(this).val()),Qt.saveSettings()})),(_=r.find(".auto_trigger")).prop("checked",i.autoTrigger),_.on("change",(function(){i.autoTrigger=$(this).prop("checked"),Qt.saveSettings()})),(y=r.find(".auto_open")).prop("checked",i.autoOpen),y.on("change",(function(){i.autoOpen=$(this).prop("checked"),Qt.saveSettings()})),(E=r.find(".show_use_action")).prop("checked",i.showUseActionIcon),E.on("change",(function(){i.showUseActionIcon=$(this).prop("checked"),Qt.saveSettings(),$(".custom-roadway_options .custom-use_action").toggle(i.showUseActionIcon)})),(w=r.find(".auto_submit_use_action")).prop("checked",i.autoSubmitUseAction),w.on("change",(function(){i.autoSubmitUseAction=$(this).prop("checked"),Qt.saveSettings()})),(x=r.find(".message_role")).val(i.messageRole),x.on("change",(function(){i.messageRole=$(this).val(),Qt.saveSettings()})),T=r.find("select.impersonate_api"),C=r.find(".impersonate_profile_section"),T.val(i.impersonateApi),"profile"===i.impersonateApi&&C.show(),T.on("change",(function(){var e=$(this).val();i.impersonateApi=e,Qt.saveSettings(),C.toggle("profile"===e)})),Vt.ConnectionManagerRequestService.handleDropdown(".roadway_settings .impersonate_connection_profile",i.impersonateProfileId,(function(e){var t;i.impersonateProfileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",Qt.saveSettings()})),P=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(P),A=new Set,$(document).on("click",".mes_magic_roadway_button",Yt(Ht().mark((function e(){var t,n,o,r,a,s,l,c,u,d,p,f,m,g,v,_,y,E,w;return Ht().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),i.profileId){e.next=5;break}return e.next=4,S("error","Please select a connection profile first in the settings.");case 4:case 8:case 22:return e.abrupt("return");case 5:if(i.promptPreset){e.next=9;break}return e.next=8,S("error","Please enter a prompt first in the settings.");case 9:if(o=$(this).closest(".mes"),r=Number(o.attr("mesid")),a=null===(t=n.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find((function(e){return e.id===i.profileId})),s=null!=a&&a.api?n.CONNECT_API_MAP[a.api]:null,l=n.chat.find((function(e,t){return t===r})),l){e.next=16;break}return e.abrupt("return");case 16:if(c=-1!==(c=h.characters.findIndex((function(e){return e.avatar===l.original_avatar})))?c:void 0,e.prev=18,!A.has(r)){e.next=23;break}return e.next=22,S("warning","A request for this message is already in progress. Please wait.");case 23:return A.add(r),$(this).addClass("spinning"),e.next=27,N(null==s?void 0:s.selected,{targetCharacterId:c,messageIndexesBetween:{end:r},presetName:null==a?void 0:a.preset,contextName:null==a?void 0:a.context,instructName:null==a?void 0:a.instruct,syspromptName:null==a?void 0:a.sysprompt,maxContext:"custom"===i.maxContextType?i.maxContextValue:"profile"===i.maxContextType?"preset":"active",includeNames:!!b.selected_group});case 27:return p=e.sent,(f=p.result).push({content:n.substituteParams(i.promptPresets[i.promptPreset].content),role:i.messageRole}),e.next=32,n.ConnectionManagerRequestService.sendRequest(i.profileId,f,i.maxResponseToken);case 32:if(m=e.sent,g=[],"bullet"!==(v=null===(u=i.promptPresets[i.promptPreset])||void 0===u?void 0:u.extractionStrategy)){e.next=40;break}if(0!==(g=Jt(m.content)).length){e.next=40;break}return e.next=40,S("warning","Could not extract any bullet points from the response. Using original response.");case 40:return _=null!==(d=g)&&void 0!==d&&d.length?g.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"):m.content,y=n.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t[qt.TARGET])===r})),E=null!=y?y:{mes:D(_,"bullet"===v?g:void 0),name:h.systemUserName,force_avatar:h.system_avatar,is_system:!0,is_user:!1,extra:$t($t($t({isSmallSys:!0},qt.TARGET,r),qt.RAW_CONTENT,_),qt.OPTIONS,g)},y?(E.mes=D(_,"bullet"===v?g:void 0),E.extra[qt.RAW_CONTENT]=m.content,E.extra[qt.OPTIONS]=g,$('[mesid="'.concat(r+1,'"] .mes_text')).html(D(_,"bullet"===v?g:void 0,"custom-"))):(n.chat.push(E),n.addOneMessage(E,{insertAfter:r})),w=$('[mesid="'.concat(r+1,'"] .mes_text details')),i.autoOpen&&!w.attr("open")&&w.attr("open",""),nn(r+1),e.next=49,n.saveChat();case 49:e.next=56;break;case 51:return e.prev=51,e.t0=e.catch(18),console.error(e.t0),e.next=56,S("error","Error: ".concat(e.t0));case 56:return e.prev=56,A.delete(r),$(".mes_magic_roadway_button").removeClass("spinning"),e.finish(56);case 60:case"end":return e.stop()}}),e,this,[[18,51,56,60]])}))));case 57:case"end":return e.stop()}}),e)}))),Zt.apply(this,arguments)}function Jt(e){return(e.match(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)(.*)$/gm)||[]).map((function(e){return e.replace(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)/,"").trim()}))}var en,tn=new class{requestMap;constructor(){this.requestMap=new Map}abortRequest(e){const t=this.requestMap.get(e);if(t){if(t.abortController)try{t.abortController.abort()}catch(e){}t.options?.onFinish&&t.options.onFinish(),this.requestMap.delete(e)}}async generateRequest(e,t){const n=SillyTavern.getContext(),o=n.uuidv4(),r=e?.custom?.stream??!1;if(this.requestMap.set(o,{abortController:t?.abortController,isStream:r,options:t}),r)try{const r=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);let i;t?.onStart&&t.onStart(o);for await(const e of r())i=e,t?.onEntry&&t.onEntry(e);t?.onFinish&&t.onFinish(i)}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(o)}else try{t?.onStart&&t.onStart(o);const r=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);this.requestMap.get(o)&&(t?.onEntry&&t.onEntry(r),t?.onFinish&&t.onFinish(r))}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(o)}return o}getActiveRequest(e){return this.requestMap.get(e)?.abortController}getAllActiveRequests(){const e=new Map;for(const[t,n]of this.requestMap)e.set(t,n.abortController);return e}};function nn(e){var t=$('[mesid="'.concat(e,'"] .custom-roadway_options'));t.find(".custom-action_button").off();var n=SillyTavern.getContext();t.find(".custom-impersonate_action").on("click",Yt(Ht().mark((function o(){var r,i,a,s,l,c,u,d,p,f,h,m,g,v,_,y,E,x,T,C,P;return Ht().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:if(i=$(this).closest(".custom-roadway_option"),a=t.find(".custom-roadway_option").index(i),s=n.chat.find((function(t,n){return e===n})),s){o.next=5;break}return o.abrupt("return");case 5:if(l=Qt.getSettings(),(c=l.promptPresets[n.extensionSettings[Xt].promptPreset])&&c.impersonate){o.next=11;break}return o.next=10,S("error","Preset not found. Please check the extension settings.");case 10:return o.abrupt("return");case 11:if(u=Vt.substituteParams(c.impersonate,void 0,void 0,void 0,void 0,void 0,{roadwaySelected:null===(r=s.extra)||void 0===r||null===(r=r[qt.OPTIONS])||void 0===r?void 0:r[a]},void 0),"profile"!==l.impersonateApi){o.next=49;break}if(l.impersonateProfileId){o.next=17;break}return o.next=16,S("error","Please select an impersonation connection profile in the settings.");case 16:return o.abrupt("return");case 17:if(p=null===(d=n.extensionSettings.connectionManager)||void 0===d||null===(d=d.profiles)||void 0===d?void 0:d.find((function(e){return e.id===l.impersonateProfileId})),null!=(f=null!=p&&p.api?n.CONNECT_API_MAP[p.api]:null)&&f.selected){o.next=22;break}return S("error","Please select an API in the connection profile."),o.abrupt("return");case 22:return Vt.deactivateSendButtons(),o.prev=23,o.next=26,N(f.selected,{presetName:null==p?void 0:p.preset,contextName:null==p?void 0:p.context,instructName:null==p?void 0:p.instruct,syspromptName:null==p?void 0:p.sysprompt,maxContext:"custom"===l.maxContextType?l.maxContextValue:"profile"===l.maxContextType?"preset":"active",includeNames:!!b.selected_group});case 26:return h=o.sent,(m=h.result).push({role:"system",content:u}),g=!0,v=l.maxResponseToken,"openai"===f.selected?(_=Vt.getPresetManager("openai").getCompletionPresetByName(null==p?void 0:p.preset))&&(g=_.stream_openai,v=_.openai_max_tokens):"textgenerationwebui"===f.selected&&(y=Vt.getPresetManager("textgenerationwebui").getCompletionPresetByName(null==p?void 0:p.preset))&&(g=null!==(E=null!==(x=y.streaming)&&void 0!==x?x:n.textCompletionSettings.streaming)&&void 0!==E&&E,v=null!==(T=y.genamt)&&void 0!==T?T:v),C=$("#send_textarea"),P=new AbortController,o.next=36,tn.generateRequest({profileId:l.impersonateProfileId,prompt:m,maxTokens:v,custom:{stream:g,signal:g?P.signal:void 0}},{abortController:g?P:void 0,onStart:function(e){en=e,Vt.eventSource.emit(Gt.GENERATION_STARTED,"impersonate",{signal:g?P.signal:void 0})},onEntry:function(e){g&&e&&(C.val(e.text),C.trigger("input"),C.trigger("change"))},onFinish:function(e,t){!g&&e&&(C.val(e.content),C.trigger("input"),C.trigger("change")),t&&S("error","Error: ".concat(t)),Vt.activateSendButtons()}});case 36:o.next=43;break;case 38:return o.prev=38,o.t0=o.catch(23),console.error(o.t0),o.next=43,S("error","Error: ".concat(o.t0));case 43:return o.prev=43,Vt.activateSendButtons(),en=void 0,o.finish(43);case 47:o.next=50;break;case 49:w("impersonate",void 0,u);case 50:case"end":return o.stop()}}),o,this,[[23,38,43,47]])})))),t.find(".custom-use_action").on("click",(function(){var e=$(this).closest(".custom-roadway_option").find(".custom-option_content").text();if(e){$("#send_textarea").val(e),$("#send_textarea").trigger("input"),Qt.getSettings().autoSubmitUseAction&&$("#send_but").trigger("click");var t=$(this);t.html("✓"),setTimeout((function(){t.html("▶️")}),1e3)}})),t.find(".custom-edit_action").on("click",Yt(Ht().mark((function o(){var r,i,a,s;return Ht().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:r=$(this).closest(".custom-roadway_option"),i=r.find(".custom-option_content"),a=i.text(),s=$("<textarea>").val(a).css({width:"100%",minHeight:"50px",resize:"vertical",backgroundColor:"var(--SmartThemeBlurTintColor)",color:"var(--SmartThemeBodyColor)",border:"1px solid var(--SmartThemeBorderColor)",borderRadius:"var(--avatar-base-border-radius)",padding:"calc(var(--mainFontSize) * 0.5)"}),i.empty().append(s),s.trigger("focus"),s.on("blur",(function(){var o,a=s.val();i.text(a);var l=n.chat.find((function(t,n){return e===n}));if(null!=l&&null!==(o=l.extra)&&void 0!==o&&o[qt.OPTIONS]){var c=t.find(".custom-roadway_option").index(r);l.extra[qt.OPTIONS][c]=a,n.saveChat()}})),s.on("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s.trigger("blur"))}));case 8:case"end":return o.stop()}}),o,this)}))))}function on(){!function(){Zt.apply(this,arguments)}(),function(){Vt.eventSource.on(Gt.CHAT_CHANGED,(function(){var e,t=SillyTavern.getContext();t.chat.length&&($(".custom-roadway_options .custom-use_action").toggle(Qt.getSettings().showUseActionIcon),"number"==typeof(null===(e=t.chat[t.chat.length-1].extra)||void 0===e?void 0:e[qt.TARGET])&&nn(t.chat.length-1))}));var e=-1;Vt.eventSource.makeFirst(Gt.CHARACTER_MESSAGE_RENDERED,(function(t,n){e=t,Qt.getSettings().autoTrigger&&"group_chat"!==n&&!b.selected_group&&$('[mesid="'.concat(t,'"]')).find(".mes_magic_roadway_button").trigger("click")}));var t=["normal","continue","swipe"];Vt.eventSource.makeFirst(Gt.GROUP_WRAPPER_FINISHED,(function(n){Qt.getSettings().autoTrigger&&-1!==e&&t.includes(n.type)&&$('[mesid="'.concat(e,'"]')).find(".mes_magic_roadway_button").trigger("click")})),$("#mes_stop").on("click",(function(){en&&tn.abortRequest(en)}))}()}if(Vt.ConnectionManagerRequestService&&Vt.getCharacterCardFields&&Vt.getWorldInfoPrompt)Qt.initializeSettings().then((function(e){e.version.changed&&e.oldSettings.version<"0.4.0"&&"0.4.0"===e.newSettings.version&&S("info","[Roadway] Added impersonate with connection profile api. Check extension settings."),on()})).catch((function(e){S("error",e),Vt.Popup.show.confirm("Data migration failed. Do you want to reset the roadway data?","Roadway").then((function(e){e&&(Qt.resetSettings(),on())}))}));else{S("error","[Roadway Error] Make sure ST is updated.")}