import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as r from"../../../../world-info.js";import*as n from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as a from"../../../../openai.js";import*as i from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";var p={d:(e,t)=>{for(var r in t)p.o(t,r)&&!p.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const l=(e=>{var t={};return p.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const u=(e=>{var t={};return p.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,main_api:()=>t.main_api,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const d=(e=>{var t={};return p.d(t,e),t})({wi_anchor_position:()=>r.wi_anchor_position,world_info_include_names:()=>r.world_info_include_names});const m=(e=>{var t={};return p.d(t,e),t})({formatInstructModeExamples:()=>n.formatInstructModeExamples});const h=(e=>{var t={};return p.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const f=(e=>{var t={};return p.d(t,e),t})({getPromptRole:()=>a.getPromptRole,prepareOpenAIMessages:()=>a.prepareOpenAIMessages,setOpenAIMessageExamples:()=>a.setOpenAIMessageExamples,setOpenAIMessages:()=>a.setOpenAIMessages});const y=(e=>{var t={};return p.d(t,e),t})({metadata_keys:()=>i.metadata_keys});const g=(e=>{var t={};return p.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const v=(e=>{var t={};return p.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});async function _(e,t){await SillyTavern.getContext().SlashCommandParser.commands.echo.callback({severity:e},t)}function x(e,t){return(0,u.parseMesExamples)(e,t)}function w(e,t,r){return(0,u.baseChatReplace)(e,t,r)}function b(e){return(0,f.getPromptRole)(e)}async function S(e){if(!["textgenerationwebui","openai"].includes(u.main_api))throw new Error("Unsupported API");const t=SillyTavern.getContext();let r=[];const n=t.chat.slice(0,e+1);let{description:o,personality:a,persona:i,scenario:s,mesExamples:c,system:p,jailbreak:_}=t.getCharacterCardFields();const S="textgenerationwebui"===u.main_api;let E=x(c,S);const P=(0,u.getMaxContextSize)(I);var I;const O=t.ToolManager.isToolCallingSupported();let k=n.filter((e=>!e.is_system||O&&Array.isArray(e.extra?.tool_invocations)));k=await Promise.all(k.map((async(e,t)=>{let r=function(e,t,{characterOverride:r,isMarkdown:n,isPrompt:o,isEdit:a,depth:i}){return(0,v.getRegexedString)(e,t,{characterOverride:r,isMarkdown:n,isPrompt:o,isEdit:a,depth:i})}(e.mes,e.is_user?v.regex_placement.USER_INPUT:v.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:k.length-t-1});return r=await async function(e,t){return await(0,h.appendFileContent)(e,t)}(e,r),e?.extra?.append_title&&e?.extra?.title&&(r=`${r}\n\n${e.extra.title}`),{...e,mes:r,index:t}})));const j=k.map((e=>d.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:A,worldInfoBefore:M,worldInfoAfter:L,worldInfoExamples:C,worldInfoDepth:T,anBefore:R,anAfter:N}=await t.getWorldInfoPrompt(j,P,!1);for(const e of C){const t=e.content;if(0===t.length)continue;const r=x(w(t,u.name1,u.name2),S);e.position===d.wi_anchor_position.before?E.unshift(...r):E.push(...r)}if("textgenerationwebui"===u.main_api){const e=[...E];E&&(E=function(e,t,r){return(0,m.formatInstructModeExamples)(e,t,r)}(E,u.name1,u.name2));const c={description:o,personality:a,persona:t.powerUserSettings.persona_description_position==l.persona_description_positions.IN_PROMPT?i:"",scenario:s,system:p,char:u.name2,user:u.name1,wiBefore:M,wiAfter:L,loreBefore:M,loreAfter:L,mesExamples:E.join(""),mesExamplesRaw:e.join("")};let d=($=c,(0,l.renderStoryString)($));r.push({role:"system",content:d,ignoreInstruct:!0}),n.filter((e=>!e.is_system)).forEach((e=>{r.push({role:e.is_user?"user":"assistant",content:e.mes})}));for(const e of T)r=[...r.slice(0,r.length-e.depth),{role:b(e.role),content:e.entries.join("\n")},...r.slice(r.length-e.depth)];const h=(D=g.selected_group,G=Number(u.this_chid),(0,g.getGroupDepthPrompts)(D,G));if(g.selected_group&&Array.isArray(h)&&h.length>0)h.forEach(((e,t)=>{r=[...r.slice(0,r.length-e.depth),{role:e.role,content:e.text},...r.slice(r.length-e.depth)]}));else{const e=w(u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),u.name1,u.name2)||"",t=u.depth_prompt_depth_default,n=u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.role??u.depth_prompt_role_default;r=[...r.slice(0,r.length-t),{role:b(n),content:e},...r.slice(r.length-t)]}const f={prompt:u.chat_metadata[y.metadata_keys.prompt],interval:u.chat_metadata[y.metadata_keys.interval],position:u.chat_metadata[y.metadata_keys.position],depth:u.chat_metadata[y.metadata_keys.depth],role:u.chat_metadata[y.metadata_keys.role]};let v=-1;if(f.prompt)switch(f.prompt=w(f.prompt,u.name1,u.name2),f.position){case u.extension_prompt_types.IN_PROMPT:r=[...r.slice(0,1),{role:"user",content:f.prompt},...r.slice(1)],v=1;break;case u.extension_prompt_types.IN_CHAT:r=[...r.slice(0,r.length-f.depth),{role:b(f.role),content:f.prompt},...r.slice(r.length-f.depth)],v=r.length-f.depth-1;break;case u.extension_prompt_types.BEFORE_PROMPT:r.unshift({role:"user",content:f.prompt}),v=0}v>=0&&(R.length>0&&(r=[...r.slice(0,v),{role:"system",content:R.join("\n")},...r.slice(v)],v++),N.length>0&&(r=[...r.slice(0,v+1),{role:"system",content:N.join("\n")},...r.slice(v+1)]))}else{let e=[],n=[];e=function(e){return(0,f.setOpenAIMessages)(e)}(k),n=function(e){return(0,f.setOpenAIMessageExamples)(e)}(E);let[c,l]=await function({name2:e,charDescription:t,charPersonality:r,Scenario:n,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:p,extensionPrompts:l,cyclePrompt:u,systemPromptOverride:d,jailbreakPromptOverride:m,personaDescription:h,messages:y,messageExamples:g},v){return(0,f.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:r,Scenario:n,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:p,cyclePrompt:u,systemPromptOverride:d,jailbreakPromptOverride:m,personaDescription:h,extensionPrompts:l,messages:y,messageExamples:g},v)}({name2:u.name2,charDescription:o,charPersonality:a,Scenario:s,worldInfoBefore:M,worldInfoAfter:L,extensionPrompts:t.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:p,jailbreakPromptOverride:_,personaDescription:i,messages:e,messageExamples:n},!1);r.push(...c)}var D,G,$;return r}function E(e){return E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},E(e)}function P(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */P=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(e,t,r){e[t]=r.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function p(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{p({},"")}catch(e){p=function(e,t,r){return e[t]=r}}function l(e,t,r,n){var a=t&&t.prototype instanceof g?t:g,i=Object.create(a.prototype),s=new L(n||[]);return o(i,"_invoke",{value:k(e,r,s)}),i}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var d="suspendedStart",m="suspendedYield",h="executing",f="completed",y={};function g(){}function v(){}function _(){}var x={};p(x,i,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(C([])));b&&b!==r&&n.call(b,i)&&(x=b);var S=_.prototype=g.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){p(e,t,(function(e){return this._invoke(t,e)}))}))}function O(e,t){function r(o,a,i,s){var c=u(e[o],e,a);if("throw"!==c.type){var p=c.arg,l=p.value;return l&&"object"==E(l)&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(l).then((function(e){p.value=e,i(p)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,n){function o(){return new t((function(t,o){r(e,n,t,o)}))}return a=a?a.then(o,o):o()}})}function k(t,r,n){var o=d;return function(a,i){if(o===h)throw Error("Generator is already running");if(o===f){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=j(s,n);if(c){if(c===y)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===d)throw o=f,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=h;var p=u(t,r,n);if("normal"===p.type){if(o=n.done?f:m,p.arg===y)continue;return{value:p.arg,done:n.done}}"throw"===p.type&&(o=f,n.method="throw",n.arg=p.arg)}}}function j(t,r){var n=r.method,o=t.iterator[n];if(o===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,j(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),y;var a=u(o,t.iterator,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,y;var i=a.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,y):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,y)}function A(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function M(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function L(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(A,this),this.reset(!0)}function C(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}throw new TypeError(E(t)+" is not iterable")}return v.prototype=_,o(S,"constructor",{value:_,configurable:!0}),o(_,"constructor",{value:v,configurable:!0}),v.displayName=p(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,p(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},I(O.prototype),p(O.prototype,s,(function(){return this})),t.AsyncIterator=O,t.async=function(e,r,n,o,a){void 0===a&&(a=Promise);var i=new O(l(e,r,n,o),a);return t.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},I(S),p(S,c,"Generator"),p(S,i,(function(){return this})),p(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=C,L.prototype={constructor:L,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(M),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),p=n.call(i,"finallyLoc");if(c&&p){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!p)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,y):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),y},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),M(r),y}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;M(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:C(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),y}},t}function I(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function O(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){I(a,n,o,i,s,"next",e)}function s(e){I(a,n,o,i,s,"throw",e)}i(void 0)}))}}var k=SillyTavern.getContext(),j={enabled:!0,profileId:"",prompt:"You are an AI assistant designed to generate creative possible actions in a roleplaying scenario. Given the following context, suggest a diverse list of options for the player to take.\n\nOutput ONLY a numbered list of the possible actions. Each action should be a clear, actionable, and concise sentence written in plain text. Include actions that relate to multiple domains (e.g., observation, manipulation, dialogue, combat, deduction.) Do not include greetings, farewells, or polite thanks in the list. Do not use words like \"you\". Use exact 10 actions.\n\nExample:\n\n1. Examine the ground for any signs of footprints or disturbed earth.\n2. Ask Mrs. Abernathy about any local rumors regarding the strange symbol.\n3. Search Mr. Peterson's abandoned house for any hidden messages or clues.\n4. Attempt to pick the lock on the neighbor's shed, hoping to find something related to their disappearances.\n5. Show the photo of the symbol to the local bartender for information."};function A(){return(A=O(P().mark((function e(){var t,r,n,o,a;return P().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=function(e){var t=document.createElement("details"),r=document.createElement("summary"),n=document.createElement("pre");return r.textContent="Roadway",n.textContent=e,t.append(r,n),t.outerHTML},e.next=3,k.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 3:t=e.sent,$("#extensions_settings").append(t),(r=$(".roadway_settings")).find("#roadway_enabled").prop("checked",k.extensionSettings.roadway.enabled).on("change",O(P().mark((function e(){var t;return P().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(t=SillyTavern.getContext()).extensionSettings.roadway.enabled=!t.extensionSettings.roadway.enabled,t.saveSettingsDebounced();case 3:case"end":return e.stop()}}),e)})))),k.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",k.extensionSettings.roadway.profileId,(function(e){var t=SillyTavern.getContext();t.extensionSettings.roadway.profileId=e?e.id:"",t.saveSettingsDebounced()})),(n=r.find(".prompt")).val(k.extensionSettings.roadway.prompt),n.on("change",(function(){var e=SillyTavern.getContext(),t=n.val();t!==e.extensionSettings.roadway.prompt&&(e.extensionSettings.roadway.prompt=t,e.saveSettingsDebounced())})),r.find(".restore_default").on("click",(function(){n.val(j.prompt),n.trigger("change")})),o=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(o),$(document).on("click",".mes_magic_roadway_button",O(P().mark((function e(){var t,r,n,o,i,s,c,p;return P().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=SillyTavern.getContext()).extensionSettings.roadway.profileId){e.next=5;break}return e.next=4,_("error","Please select a connection profile first in the settings.");case 4:case 8:return e.abrupt("return");case 5:if(t.extensionSettings.roadway.prompt){e.next=9;break}return e.next=8,_("error","Please enter a prompt first in the settings.");case 9:return r=$(this).closest(".mes"),n=Number(r.attr("mesid")),e.next=13,S(n);case 13:return(o=e.sent).push({content:t.extensionSettings.roadway.prompt,role:"system"}),e.next=17,t.ConnectionManagerRequestService.sendRequest(t.extensionSettings.roadway.profileId,o,500);case 17:return i=e.sent,s=t.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t.roadway_target_chat)===n})),c=null!=s?s:{mes:a(i.content),name:u.systemUserName,force_avatar:u.system_avatar,is_system:!0,is_user:!1,extra:{isSmallSys:!0,roadway_target_chat:n}},s?(c.mes=a(i.content),p=t.chat.indexOf(s),$('[mesid="'.concat(p,'"] .mes_text')).html(c.mes)):(t.chat.push(c),t.addOneMessage(c,{insertAfter:n})),e.next=23,t.saveChat();case 23:case"end":return e.stop()}}),e,this)}))));case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){k.extensionSettings.roadway=k.extensionSettings.roadway||{};for(var e=!1,t=0,r=Object.keys(j);t<r.length;t++){var n=r[t];void 0===k.extensionSettings.roadway[n]&&(k.extensionSettings.roadway[n]=j[n],e=!0)}e&&k.saveSettingsDebounced()}(),function(){A.apply(this,arguments)}();