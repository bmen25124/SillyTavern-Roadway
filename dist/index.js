import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as a from"../../../../openai.js";import*as i from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";var p={d:(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const u=(e=>{var t={};return p.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const d=(e=>{var t={};return p.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const m=(e=>{var t={};return p.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const f=(e=>{var t={};return p.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const h=(e=>{var t={};return p.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const g=(e=>{var t={};return p.d(t,e),t})({formatWorldInfo:()=>a.formatWorldInfo,getPromptPosition:()=>a.getPromptPosition,getPromptRole:()=>a.getPromptRole,prepareOpenAIMessages:()=>a.prepareOpenAIMessages,setOpenAIMessageExamples:()=>a.setOpenAIMessageExamples,setOpenAIMessages:()=>a.setOpenAIMessages});const _=(e=>{var t={};return p.d(t,e),t})({metadata_keys:()=>i.metadata_keys});const v=(e=>{var t={};return p.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const y=(e=>{var t={};return p.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});(e=>{var t={};p.d(t,e)})({});async function E(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}async function x(e,t,{escapeHtml:n=!0}={}){await E("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function w(e){return(0,d.getMaxContextSize)(e)}function S(e,t){return(0,d.parseMesExamples)(e,t)}function P(e,t,n){return(0,d.baseChatReplace)(e,t,n)}function T(e){return(0,g.getPromptRole)(e)}function A(e,{wiFormat:t}={}){return(0,g.formatWorldInfo)(e,{wiFormat:t})}function C(e){return(0,g.getPromptPosition)(e)}function b(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const a=t.label||"preset",i=document.createElement("div");i.className="preset-select-container",i.style.display="flex",i.style.alignItems="center";const s=e=>r.includes(e);if(o.parentNode?.insertBefore(i,o),i.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,s(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${a}`,e.setAttribute("data-i18n",`[title]Create a new ${a}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await n.Popup.show.input(`Create a new ${a}`,`Please enter a name for the new ${a}:`,"");if(null===e||""===e.trim())return;const r=e.trim();if(Array.from(o.options).some((e=>e.textContent===r)))return void await x("warning",`A ${a} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(r))return}const i=document.createElement("option");i.value=r,i.textContent=r,o.appendChild(i);const s=o.value;o.value=r,t.create?.onAfterCreate&&await t.create.onAfterCreate(r),t.onSelectChange&&s!==r&&await t.onSelectChange(s,r),c=r})),i.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${a}`,e.setAttribute("data-i18n",`[title]Rename a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await x("warning",`Please select a ${a} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(s(r))return void await x("warning",`This ${a} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const i=await n.Popup.show.input(`Rename ${a}`,`Please enter a new name for "${r}":`,r);if(null===i||""===i.trim()||i===r)return;const l=i.trim();if(Array.from(o.options).some((t=>t.textContent===l&&t!==e)))await x("warning",`A ${a} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,l))return}e.value=l,e.textContent=l,r===c&&(c=l),t.rename?.onAfterRename&&await t.rename.onAfterRename(r,l),t.onSelectChange&&o.value===l&&await t.onSelectChange(r,l)}})),i.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${a}`,e.setAttribute("data-i18n",`[title]Delete a ${a}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await x("warning",`Please select a ${a} to delete.`);const e=o.options[o.selectedIndex],r=e.value,i=o.selectedIndex;if(s(r))return void await x("warning",`This ${a} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Are you sure you want to delete "${r}"?`,`Delete ${a}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const l=r;let p,u=-1;o.options.length>1&&(u=i<o.options.length-1?i:i-1,p=o.options[u].value),o.removeChild(e),u>=0?(o.selectedIndex=u,c=p,t.onSelectChange&&await t.onSelectChange(l,p)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),i.appendChild(e)}return{select:o,container:i}}async function R(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:a,maxContext:i,includeNames:s,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:p,messageIndexesBetween:E}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const x=SillyTavern.getContext();let b=[],{description:R,personality:O,persona:I,scenario:N,mesExamples:D,system:M,jailbreak:k}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:x.getCharacterCardFields({chid:t});const L="textgenerationwebui"===e?x.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,G=!!L?.enabled;let $=S(D,G);const F=function(){if("number"==typeof i)return i;if(!i)return w();if("active"===i||!n)return w();if("number"==typeof i)return i;let t;if("textgenerationwebui"===e){const e=x.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=x.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:w()}();if(F<=0)return[];const B=x.ToolManager.isToolCallingSupported(),j=E?.start??0,H=E?.end?E.end+1:void 0;let U=-1===j&&0===H?[]:x.chat.slice(j,H).filter((e=>!e.is_system||B&&Array.isArray(e.extra?.tool_invocations)));U=await Promise.all(U.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i}){return(0,y.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:a,depth:i})}(e.mes,e.is_user?y.regex_placement.USER_INPUT:y.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:U.length-t-1});return n=await async function(e,t){return await(0,h.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const V=U.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:q,worldInfoBefore:W,worldInfoAfter:Y,worldInfoExamples:K,worldInfoDepth:z,anBefore:X,anAfter:Q}=p?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await x.getWorldInfoPrompt(V,F,!1);for(const ie of K){const se=ie.content;if(0===se.length)continue;const ce=S(P(se,d.name1,d.name2),G);ie.position===m.wi_anchor_position.before?$.unshift(...ce):$.push(...ce)}function J(){let e=0;const t=[];for(let n=U.length-1;n>=0;n--){const r=U[n];if(r.extra?.token_count&&e+r.extra.token_count>F)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:s?`${r.name}: ${r.mes}`:r.mes})}b.push(...t)}if("textgenerationwebui"===e){const le=[...$];$&&($=function(e,t,n){return(0,f.formatInstructModeExamples)(e,t,n)}($,d.name1,d.name2));const pe=x.getPresetManager("sysprompt")?.getCompletionPresetByName(a);pe&&(M=x.powerUserSettings.prefer_character_prompt&&M?M:P(pe.content,d.name1,d.name2),M=G?(ee=x.substituteParams(M,d.name1,d.name2,pe.content),te=L,(0,f.formatInstructModeSystemPrompt)(ee,te)):M);const ue={description:R,personality:O,persona:x.powerUserSettings.persona_description_position==u.persona_description_positions.IN_PROMPT?I:"",scenario:N,system:M,char:d.name2,user:d.name1,wiBefore:W,wiAfter:Y,loreBefore:W,loreAfter:Y,mesExamples:$.join(""),mesExamplesRaw:le.join("")},de=x.getPresetManager("context")?.getCompletionPresetByName(o);let me=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,u.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(ue,{customInstructSettings:L,customStoryString:de?.story_string});b.push({role:"system",content:me,ignoreInstruct:!0}),J()}else{let fe=(Z=U,(0,g.setOpenAIMessages)(Z)),he=function(e){return(0,g.setOpenAIMessageExamples)(e)}($);async function ge(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,extensionPrompts:p,cyclePrompt:u,systemPromptOverride:d,jailbreakPromptOverride:m,personaDescription:f,messages:h,messageExamples:_},v){return(0,g.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:a,bias:i,type:s,quietPrompt:c,quietImage:l,cyclePrompt:u,systemPromptOverride:d,jailbreakPromptOverride:m,personaDescription:f,extensionPrompts:p,messages:h,messageExamples:_},v)}({name2:d.name2,charDescription:R,charPersonality:O,Scenario:N,worldInfoBefore:W,worldInfoAfter:Y,extensionPrompts:x.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:M,jailbreakPromptOverride:k,personaDescription:I,messages:fe,messageExamples:he},!1);b.push(...e)}if(!n)return await ge(),b;const _e=x.getPresetManager("openai")?.getCompletionPresetByName(n);if(!_e)return console.warn(`Preset not found: ${n}. Using current preset.`),ge(),b;let ve=_e.prompt_order.find((e=>e.character_id===d.this_chid));if(!ve&&_e.prompt_order.length>0&&(ve=_e.prompt_order[0]),!ve)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),ge(),b;const ye=N&&_e.scenario_format?x.substituteParams(_e.scenario_format):"",Ee=O&&_e.personality_format?x.substituteParams(_e.personality_format):"",xe=x.substituteParams(_e.group_nudge_prompt),we=_e.impersonation_prompt?x.substituteParams(_e.impersonation_prompt):"",Se=[];p&&Se.push({role:"system",content:A(W,{wiFormat:_e.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:A(Y,{wiFormat:_e.wi_format}),identifier:"worldInfoAfter"}),c||Se.push({role:"system",content:R,identifier:"charDescription"},{role:"system",content:Ee,identifier:"charPersonality"},{role:"system",content:ye,identifier:"scenario"}),Se.push({role:"system",content:we,identifier:"impersonate"},{role:"system",content:xe,identifier:"groupNudge"});const Pe=x.extensionPrompts["1_memory"];Pe&&Pe.value&&Se.push({role:T(Pe.role),content:Pe.value,identifier:"summary",position:C(Pe.position)});const Te=x.extensionPrompts["2_floating_prompt"];!l&&Te&&Te.value&&Se.push({role:T(Te.role),content:Te.value,identifier:"authorsNote",position:C(Te.position)});const Ae=x.extensionPrompts["3_vectors"];Ae&&Ae.value&&Se.push({role:"system",content:Ae.value,identifier:"vectorsMemory",position:C(Ae.position)});const Ce=x.extensionPrompts["4_vectors_data_bank"];Ce&&Ce.value&&Se.push({role:T(Ce.role),content:Ce.value,identifier:"vectorsDataBank",position:C(Ce.position)});const be=x.extensionPrompts.chromadb;be&&be.value&&Se.push({role:"system",content:be.value,identifier:"smartContext",position:C(be.position)}),!c&&x.powerUserSettings.persona_description&&x.powerUserSettings.persona_description_position===u.persona_description_positions.IN_PROMPT&&Se.push({role:"system",content:x.powerUserSettings.persona_description,identifier:"personaDescription"}),ve.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,Se.find((e=>e.identifier===n)));var n;t&&t.content?b.push({role:t.role??"system",content:x.substituteParams(t.content)}):"chatHistory"===e.identifier&&J()}))}var Z,ee,te;const ne=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Re in x.extensionPrompts)if(Object.hasOwn(x.extensionPrompts,Re)){const Oe=x.extensionPrompts[Re];if(ne.includes(Re))continue;if(!x.extensionPrompts[Re].value)continue;if(![d.extension_prompt_types.BEFORE_PROMPT,d.extension_prompt_types.IN_PROMPT].includes(Oe.position))continue;if("function"==typeof Oe.filter&&!await Oe.filter())continue;Oe.position===d.extension_prompt_types.BEFORE_PROMPT?b=[...b.slice(0,Oe.depth),{role:T(Oe.role)??"system",content:Oe.value},...b.slice(Oe.depth)]:Oe.position===d.extension_prompt_types.IN_PROMPT&&(b=[...b.slice(0,b.length-Oe.depth),{role:T(Oe.role)??"system",content:Oe.value},...b.slice(b.length-Oe.depth)])}for(const Ie of z)b=[...b.slice(0,b.length-Ie.depth),{role:T(Ie.role),content:Ie.entries.join("\n")},...b.slice(b.length-Ie.depth)];if(!c){const Ne=(re=v.selected_group,oe=Number(d.this_chid),(0,v.getGroupDepthPrompts)(re,oe));if(v.selected_group&&Array.isArray(Ne)&&Ne.length>0)Ne.filter((e=>e.text)).forEach(((e,t)=>{b=[...b.slice(0,b.length-e.depth),{role:e.role,content:e.text},...b.slice(b.length-e.depth)]}));else{const De=P(d.characters[d.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),d.name1,d.name2)||"";if(De){const Me=d.depth_prompt_depth_default,ke=d.characters[d.this_chid]?.data?.extensions?.depth_prompt?.role??d.depth_prompt_role_default;b=[...b.slice(0,b.length-Me),{role:T(ke),content:De},...b.slice(b.length-Me)]}}}var re,oe;let ae=-1;if(!l){const Le={prompt:d.chat_metadata[_.metadata_keys.prompt],interval:d.chat_metadata[_.metadata_keys.interval],position:d.chat_metadata[_.metadata_keys.position],depth:d.chat_metadata[_.metadata_keys.depth],role:d.chat_metadata[_.metadata_keys.role]};if(Le.prompt)switch(Le.prompt=P(Le.prompt,d.name1,d.name2),Le.position){case d.extension_prompt_types.IN_PROMPT:b=[...b.slice(0,1),{role:"user",content:Le.prompt},...b.slice(1)],ae=1;break;case d.extension_prompt_types.IN_CHAT:b=[...b.slice(0,b.length-Le.depth),{role:T(Le.role),content:Le.prompt},...b.slice(b.length-Le.depth)],ae=b.length-Le.depth-1;break;case d.extension_prompt_types.BEFORE_PROMPT:b.unshift({role:"user",content:Le.prompt}),ae=0}}return ae>=0&&(X.length>0&&(b=[...b.slice(0,ae),{role:"system",content:X.join("\n")},...b.slice(ae)],ae++),Q.length>0&&(b=[...b.slice(0,ae+1),{role:"system",content:Q.join("\n")},...b.slice(ae+1)])),b}var O;function I(e){return I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},I(e)}function N(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=I(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=I(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==I(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function D(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */D=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function p(e,t,n,r){var a=t&&t.prototype instanceof _?t:_,i=Object.create(a.prototype),s=new O(r||[]);return o(i,"_invoke",{value:A(e,n,s)}),i}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=p;var d="suspendedStart",m="suspendedYield",f="executing",h="completed",g={};function _(){}function v(){}function y(){}var E={};l(E,i,(function(){return this}));var x=Object.getPrototypeOf,w=x&&x(x(N([])));w&&w!==n&&r.call(w,i)&&(E=w);var S=y.prototype=_.prototype=Object.create(E);function P(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function T(e,t){function n(o,a,i,s){var c=u(e[o],e,a);if("throw"!==c.type){var l=c.arg,p=l.value;return p&&"object"==I(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(p).then((function(e){l.value=e,i(l)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function A(t,n,r){var o=d;return function(a,i){if(o===f)throw Error("Generator is already running");if(o===h){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var s=r.delegate;if(s){var c=C(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===d)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=u(t,n,r);if("normal"===l.type){if(o=r.done?h:m,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function C(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,C(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=u(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function b(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(b,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(I(t)+" is not iterable")}return v.prototype=y,o(S,"constructor",{value:y,configurable:!0}),o(y,"constructor",{value:v,configurable:!0}),v.displayName=l(y,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,l(e,c,"GeneratorFunction")),e.prototype=Object.create(S),e},t.awrap=function(e){return{__await:e}},P(T.prototype),l(T.prototype,s,(function(){return this})),t.AsyncIterator=T,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new T(p(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},P(S),l(S,c,"Generator"),l(S,i,(function(){return this})),l(S,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(R),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),l=r.call(i,"finallyLoc");if(c&&l){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;R(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function M(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function k(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function i(e){M(a,r,o,i,s,"next",e)}function s(e){M(a,r,o,i,s,"throw",e)}i(void 0)}))}}!function(e){e.APP_READY="app_ready",e.EXTRAS_CONNECTED="extras_connected",e.MESSAGE_SWIPED="message_swiped",e.MESSAGE_SENT="message_sent",e.MESSAGE_RECEIVED="message_received",e.MESSAGE_EDITED="message_edited",e.MESSAGE_DELETED="message_deleted",e.MESSAGE_UPDATED="message_updated",e.MESSAGE_FILE_EMBEDDED="message_file_embedded",e.MORE_MESSAGES_LOADED="more_messages_loaded",e.IMPERSONATE_READY="impersonate_ready",e.CHAT_CHANGED="chat_id_changed",e.GENERATION_AFTER_COMMANDS="GENERATION_AFTER_COMMANDS",e.GENERATION_STARTED="generation_started",e.GENERATION_STOPPED="generation_stopped",e.GENERATION_ENDED="generation_ended",e.EXTENSIONS_FIRST_LOAD="extensions_first_load",e.EXTENSION_SETTINGS_LOADED="extension_settings_loaded",e.SETTINGS_LOADED="settings_loaded",e.SETTINGS_UPDATED="settings_updated",e.GROUP_UPDATED="group_updated",e.MOVABLE_PANELS_RESET="movable_panels_reset",e.SETTINGS_LOADED_BEFORE="settings_loaded_before",e.SETTINGS_LOADED_AFTER="settings_loaded_after",e.CHATCOMPLETION_SOURCE_CHANGED="chatcompletion_source_changed",e.CHATCOMPLETION_MODEL_CHANGED="chatcompletion_model_changed",e.OAI_PRESET_CHANGED_BEFORE="oai_preset_changed_before",e.OAI_PRESET_CHANGED_AFTER="oai_preset_changed_after",e.OAI_PRESET_EXPORT_READY="oai_preset_export_ready",e.OAI_PRESET_IMPORT_READY="oai_preset_import_ready",e.WORLDINFO_SETTINGS_UPDATED="worldinfo_settings_updated",e.WORLDINFO_UPDATED="worldinfo_updated",e.CHARACTER_EDITED="character_edited",e.CHARACTER_PAGE_LOADED="character_page_loaded",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_BEFORE="character_group_overlay_state_change_before",e.CHARACTER_GROUP_OVERLAY_STATE_CHANGE_AFTER="character_group_overlay_state_change_after",e.USER_MESSAGE_RENDERED="user_message_rendered",e.CHARACTER_MESSAGE_RENDERED="character_message_rendered",e.FORCE_SET_BACKGROUND="force_set_background",e.CHAT_DELETED="chat_deleted",e.CHAT_CREATED="chat_created",e.GROUP_CHAT_DELETED="group_chat_deleted",e.GROUP_CHAT_CREATED="group_chat_created",e.GENERATE_BEFORE_COMBINE_PROMPTS="generate_before_combine_prompts",e.GENERATE_AFTER_COMBINE_PROMPTS="generate_after_combine_prompts",e.GENERATE_AFTER_DATA="generate_after_data",e.GROUP_MEMBER_DRAFTED="group_member_drafted",e.GROUP_WRAPPER_STARTED="group_wrapper_started",e.GROUP_WRAPPER_FINISHED="group_wrapper_finished",e.WORLD_INFO_ACTIVATED="world_info_activated",e.TEXT_COMPLETION_SETTINGS_READY="text_completion_settings_ready",e.CHAT_COMPLETION_SETTINGS_READY="chat_completion_settings_ready",e.CHAT_COMPLETION_PROMPT_READY="chat_completion_prompt_ready",e.CHARACTER_FIRST_MESSAGE_SELECTED="character_first_message_selected",e.CHARACTER_DELETED="characterDeleted",e.CHARACTER_DUPLICATED="character_duplicated",e.CHARACTER_RENAMED="character_renamed",e.SMOOTH_STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_TOKEN_RECEIVED="stream_token_received",e.STREAM_REASONING_DONE="stream_reasoning_done",e.FILE_ATTACHMENT_DELETED="file_attachment_deleted",e.WORLDINFO_FORCE_ACTIVATE="worldinfo_force_activate",e.OPEN_CHARACTER_LIBRARY="open_character_library",e.ONLINE_STATUS_CHANGED="online_status_changed",e.IMAGE_SWIPED="image_swiped",e.CONNECTION_PROFILE_LOADED="connection_profile_loaded",e.TOOL_CALLS_PERFORMED="tool_calls_performed",e.TOOL_CALLS_RENDERED="tool_calls_rendered"}(O||(O={}));var L=SillyTavern.getContext(),G="roadway",F={TARGET:"roadway_target_chat",RAW_CONTENT:"roadway_raw_content",OPTIONS:"roadway_options"},B="Your task this time is to write your response as if you were {{user}}, impersonating their style. Use {{user}}'s dialogue and actions so far as a guideline for how they would likely act. Don't ever write as {{char}}. Only talk and act as {{user}}. This is what {{user}}'s focus:\n\n{{roadwaySelected}}",j="You are an AI brainstorming partner, helping to create immersive and surprising roleplaying experiences, **building upon the established context from our previous conversation.** Your task is to generate an *unpredictable* and *engaging* list of options for **{{user}}**, specifically tailored to their character, the world, and the current situation as established in our previous dialogue. These should be framed as possible actions that **{{user}}** *could* take.\n\nOutput ONLY a numbered list of possible actions. Each action should be a clear, actionable, concise, and *creative* sentence written in plain text suggesting an action **{{user}}** can perform in the game.\n\nPrioritize *varied* actions that span multiple domains:\n\n{Observation/Investigation; Dialogue/Persuasion; Stealth/Intrigue; Combat/Conflict; Crafting/Repair; Knowledge/Lore; Movement/Traversal; Deception/Manipulation; Performance/Entertainment; Technical/Mechanical}.\n\nAvoid obvious or repetitive actions **that {{user}} has already explored or are contrary to the established character/world.** Push the boundaries of the situation. Challenge **{{user}}'s** expectations. Do not include greetings, farewells, polite thanks, or options that break character. Generate *exactly* 6 actions. The actions must be written in plain text.\n\nHere are a few example actions to inspire creativity:\n\n1. Attempt to communicate with the forest creatures to learn the location of hidden trails.\n2. Bribe the corrupt city guard with a song and a dance.\n3. Stage a fake ambush to draw out a hidden enemy.",H={version:"0.4.0",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:500,promptPreset:"default",autoTrigger:!1,autoOpen:!0,impersonateApi:"main",showUseActionIcon:!0,promptPresets:{default:{content:j,extractionStrategy:"bullet",impersonate:B}}},U=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],a={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),a;const i={...a,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function s(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},s(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(i.version.changed=!0,i.version.new=n,o.version=n),r&&o.formatVersion!==r&&(i.formatVersion.changed=!0,i.formatVersion.new=r,o.formatVersion=r),(s(o,this.defaultSettings)||i.version.changed||i.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,i.version.changed=!0,i.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,i.formatVersion.changed=!0,i.formatVersion.new=r);let c=structuredClone(o),l=o.formatVersion;try{for(const p of t)if(l===p.from){c=await p.action(c),l=p.to,c.formatVersion=p.to;const u=this.defaultSettings.version;u&&(c.version=u),i.formatVersion.changed=!0,i.formatVersion.new=p.to}if(i.formatVersion.changed){Object.assign(o,c);for(const d of Object.keys(o))Object.keys(c).includes(d)||delete o[d];this.saveSettings()}}catch(m){throw console.error("Failed to apply version changes:",m),new Error(`Version migration failed: ${m instanceof Error?m.message:m}`,{cause:m})}}return i.newSettings=o,i}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}(G,H);function V(){return V=k(D().mark((function e(){var t,n,r,o,a,i,s,c,l,p,u,m,f,h,g,_,y,E,w,S,P,T,A;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return A=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=document.createElement("details"),o=document.createElement("summary");if(o.textContent="Roadway",r.appendChild(o),null!=t&&t.length){var a=document.createElement("div");a.classList.add("".concat(n,"roadway_options")),t.forEach((function(e,t){var r=document.createElement("div");r.classList.add("".concat(n,"roadway_option"));var o=document.createElement("div");o.classList.add("".concat(n,"option_actions"));var i=document.createElement("div");i.classList.add("".concat(n,"action_button"),"".concat(n,"impersonate_action")),i.innerHTML="✍️",i.title="Impersonate";var s=document.createElement("div");s.classList.add("".concat(n,"action_button"),"".concat(n,"edit_action")),s.innerHTML="✏️",s.title="Edit";var c=U.getSettings(),l=document.createElement("div");l.classList.add("".concat(n,"action_button"),"".concat(n,"use_action")),l.innerHTML="▶️",l.title="Use option",l.style.display=c.showUseActionIcon?"inline-block":"none",o.appendChild(l),o.appendChild(i),o.appendChild(s);var p=document.createElement("div");p.classList.add("".concat(n,"option_content")),p.textContent=e,r.appendChild(o),r.appendChild(p),a.appendChild(r)})),r.appendChild(a)}else{var i=document.createElement("pre");i.classList.add("".concat(n,"roadway_pre")),i.textContent=e,r.appendChild(i)}return r.outerHTML},m=function(){var e,t=a.promptPresets[a.promptPreset];l.val(null==t?void 0:t.extractionStrategy);var n="none"===(null==t?void 0:t.extractionStrategy);p.toggle(!n),u.val(null!==(e=null==t?void 0:t.impersonate)&&void 0!==e?e:"")},e.next=4,L.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 4:r=e.sent,$("#extensions_settings").append(r),o=$(".roadway_settings"),a=U.getSettings(),L.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",a.profileId,(function(e){var t;a.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",U.saveSettings()})),i=b(".roadway_settings select.prompt",{label:"prompt",initialValue:a.promptPreset,initialList:Object.keys(a.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=k(D().mark((function e(t,n){var r,o,i,s,d,m,f;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:f=null!=n?n:"default",a.promptPreset=f,U.saveSettings(),c.val(null!==(r=null===(o=a.promptPresets[f])||void 0===o?void 0:o.content)&&void 0!==r?r:""),l.val(null===(i=a.promptPresets[f])||void 0===i?void 0:i.extractionStrategy),u.val(null!==(s=null===(d=a.promptPresets[f])||void 0===d?void 0:d.impersonate)&&void 0!==s?s:""),p.css("display","none"===(null===(m=a.promptPresets[f])||void 0===m?void 0:m.extractionStrategy)?"none":"block");case 7:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n,r,o=a.promptPresets[a.promptPreset];a.promptPresets[e]={content:null!==(t=null==o?void 0:o.content)&&void 0!==t?t:j,extractionStrategy:null!==(n=null==o?void 0:o.extractionStrategy)&&void 0!==n?n:"bullet",impersonate:null!==(r=null==o?void 0:o.impersonate)&&void 0!==r?r:B}}},rename:{onAfterRename:function(e,t){a.promptPresets[t]=a.promptPresets[e],delete a.promptPresets[e]}},delete:{onAfterDelete:function(e){delete a.promptPresets[e]}}}),s=i.select,(c=o.find("textarea.prompt")).val(null!==(t=null===(n=a.promptPresets[a.promptPreset])||void 0===n?void 0:n.content)&&void 0!==t?t:""),c.on("change",(function(){var e=c.val();a.promptPresets[a.promptPreset].content=e,U.saveSettings()})),l=o.find("select.extraction_strategy"),p=o.find(".impersonate_section"),u=o.find("textarea.impersonate"),m(),l.on("change",(function(){var e=$(this).val();a.promptPresets[a.promptPreset].extractionStrategy=e,U.saveSettings();var t="none"===e;p.toggle(!t)})),u.on("change",(function(){a.promptPresets[a.promptPreset].impersonate=$(this).val(),U.saveSettings()})),s.addEventListener("change",m),o.find(".restore_default").on("click",k(D().mark((function e(){return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,L.Popup.show.confirm("Are you sure you want to restore the default prompt?","Restore default");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:a.promptPresets.default={content:j,extractionStrategy:"bullet",impersonate:B},c.val(j),l.val("bullet"),u.val(B),"default"!==s.value?(s.value="default",s.dispatchEvent(new Event("change"))):U.saveSettings();case 10:case"end":return e.stop()}}),e)})))),f=o.find(".max_context_type"),h=o.find(".max_context_value"),g=o.find(".max_context_custom"),f.val(a.maxContextType),h.val(a.maxContextValue),"custom"===a.maxContextType&&g.show(),f.on("change",(function(){var e=$(this).val();a.maxContextType=e,U.saveSettings(),g.toggle("custom"===e)})),h.on("change",(function(){a.maxContextValue=Number($(this).val()),U.saveSettings()})),(_=o.find(".max_response_tokens")).val(a.maxResponseToken),_.on("change",(function(){a.maxResponseToken=Number($(this).val()),U.saveSettings()})),(y=o.find(".auto_trigger")).prop("checked",a.autoTrigger),y.on("change",(function(){a.autoTrigger=$(this).prop("checked"),U.saveSettings()})),(E=o.find(".auto_open")).prop("checked",a.autoOpen),E.on("change",(function(){a.autoOpen=$(this).prop("checked"),U.saveSettings()})),(w=o.find(".show_use_action")).prop("checked",a.showUseActionIcon),w.on("change",(function(){a.showUseActionIcon=$(this).prop("checked"),U.saveSettings(),$(".custom-roadway_options .custom-use_action").toggle(a.showUseActionIcon)})),(S=o.find("select.impersonate_api")).val(a.impersonateApi),S.on("change",(function(){a.impersonateApi=$(this).val(),U.saveSettings()})),P=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(P),T=new Set,$(document).on("click",".mes_magic_roadway_button",k(D().mark((function e(){var t,n,r,o,i,s,c,l,p,u,m,f,h,g,_,y,E,w;return D().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),a.profileId){e.next=5;break}return e.next=4,x("error","Please select a connection profile first in the settings.");case 4:case 8:case 22:return e.abrupt("return");case 5:if(a.promptPreset){e.next=9;break}return e.next=8,x("error","Please enter a prompt first in the settings.");case 9:if(r=$(this).closest(".mes"),o=Number(r.attr("mesid")),i=null===(t=n.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find((function(e){return e.id===a.profileId})),s=null!=i&&i.api?n.CONNECT_API_MAP[i.api]:null,c=n.chat.find((function(e,t){return t===o}))){e.next=16;break}return e.abrupt("return");case 16:if(l=-1!==(l=d.characters.findIndex((function(e){return e.avatar===c.original_avatar})))?l:void 0,e.prev=18,!T.has(o)){e.next=23;break}return e.next=22,x("warning","A request for this message is already in progress. Please wait.");case 23:return T.add(o),$(this).addClass("spinning"),e.next=27,R(null==s?void 0:s.selected,{targetCharacterId:l,messageIndexesBetween:{end:o},presetName:null==i?void 0:i.preset,contextName:null==i?void 0:i.context,instructName:null==i?void 0:i.instruct,syspromptName:null==i?void 0:i.sysprompt,maxContext:"custom"===a.maxContextType?a.maxContextValue:"profile"===a.maxContextType?"preset":"active",includeNames:!!v.selected_group});case 27:return(m=e.sent).push({content:n.substituteParams(a.promptPresets[a.promptPreset].content),role:"system"}),e.next=31,n.ConnectionManagerRequestService.sendRequest(a.profileId,m,a.maxResponseToken);case 31:if(f=e.sent,h=[],"bullet"!==(g=null===(p=a.promptPresets[a.promptPreset])||void 0===p?void 0:p.extractionStrategy)){e.next=39;break}if(S=f.content,P=void 0,P=S.match(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)(.*)$/gm)||[],0!==(h=P.map((function(e){return e.replace(/^(?:\d+\.(?:\s+|(?=\S))|-\s+)/,"").trim()}))).length){e.next=39;break}return e.next=39,x("warning","Could not extract any bullet points from the response. Using original response.");case 39:return _=null!==(u=h)&&void 0!==u&&u.length?h.map((function(e,t){return"".concat(t+1,". ").concat(e)})).join("\n"):f.content,y=n.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t[F.TARGET])===o})),E=null!=y?y:{mes:A(_,"bullet"===g?h:void 0),name:d.systemUserName,force_avatar:d.system_avatar,is_system:!0,is_user:!1,extra:N(N(N({isSmallSys:!0},F.TARGET,o),F.RAW_CONTENT,_),F.OPTIONS,h)},y?(E.mes=A(_,"bullet"===g?h:void 0),E.extra[F.RAW_CONTENT]=f.content,E.extra[F.OPTIONS]=h,$('[mesid="'.concat(o+1,'"] .mes_text')).html(A(_,"bullet"===g?h:void 0,"custom-"))):(n.chat.push(E),n.addOneMessage(E,{insertAfter:o})),w=$('[mesid="'.concat(o+1,'"] .mes_text details')),a.autoOpen&&!w.attr("open")&&w.attr("open",""),Y(o+1),e.next=48,n.saveChat();case 48:e.next=55;break;case 50:return e.prev=50,e.t0=e.catch(18),console.error(e.t0),e.next=55,x("error","Error: ".concat(e.t0));case 55:return e.prev=55,T.delete(o),$(".mes_magic_roadway_button").removeClass("spinning"),e.finish(55);case 59:case"end":return e.stop()}var S,P}),e,this,[[18,50,55,59]])}))));case 48:case"end":return e.stop()}}),e)}))),V.apply(this,arguments)}var q,W=new class{requestMap;constructor(){this.requestMap=new Map}abortRequest(e){const t=this.requestMap.get(e);if(t){if(t.abortController)try{t.abortController.abort()}catch(e){}t.options?.onFinish&&t.options.onFinish(),this.requestMap.delete(e)}}async generateRequest(e,t){const n=SillyTavern.getContext(),r=n.uuidv4(),o=e?.custom?.stream??!1;if(this.requestMap.set(r,{abortController:t?.abortController,isStream:o,options:t}),o)try{const o=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);let a;t?.onStart&&t.onStart(r);for await(const e of o())a=e,t?.onEntry&&t.onEntry(e);t?.onFinish&&t.onFinish(a)}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(r)}else try{t?.onStart&&t.onStart(r);const o=await n.ConnectionManagerRequestService.sendRequest(e.profileId,e.prompt,e.maxTokens,e.custom);this.requestMap.get(r)&&(t?.onEntry&&t.onEntry(o),t?.onFinish&&t.onFinish(o))}catch(e){t?.onFinish&&t.onFinish(void 0,e)}finally{this.requestMap.delete(r)}return r}getActiveRequest(e){return this.requestMap.get(e)?.abortController}getAllActiveRequests(){const e=new Map;for(const[t,n]of this.requestMap)e.set(t,n.abortController);return e}};function Y(e){var t=$('[mesid="'.concat(e,'"] .custom-roadway_options'));t.find(".custom-action_button").off();var n=SillyTavern.getContext();t.find(".custom-impersonate_action").on("click",k(D().mark((function r(){var o,a,i,s,c,l,p,u,d,m,f,h,g,_,y,w,S,P,T,A;return D().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(a=$(this).closest(".custom-roadway_option"),i=t.find(".custom-roadway_option").index(a),s=n.chat.find((function(t,n){return e===n})),s){r.next=5;break}return r.abrupt("return");case 5:if(c=U.getSettings(),(l=c.promptPresets[n.extensionSettings[G].promptPreset])&&l.impersonate){r.next=11;break}return r.next=10,x("error","Preset not found. Please check the extension settings.");case 10:return r.abrupt("return");case 11:if(p=L.substituteParams(l.impersonate,void 0,void 0,void 0,void 0,void 0,{roadwaySelected:null===(o=s.extra)||void 0===o||null===(o=o[F.OPTIONS])||void 0===o?void 0:o[i]},void 0),"profile"!==c.impersonateApi){r.next=48;break}if(c.profileId){r.next=17;break}return r.next=16,x("error","Please select a connection profile first in the settings.");case 16:return r.abrupt("return");case 17:if(d=null===(u=n.extensionSettings.connectionManager)||void 0===u||null===(u=u.profiles)||void 0===u?void 0:u.find((function(e){return e.id===c.profileId})),null!=(m=null!=d&&d.api?n.CONNECT_API_MAP[d.api]:null)&&m.selected){r.next=22;break}return x("error","Please select an API in the connection profile."),r.abrupt("return");case 22:return L.deactivateSendButtons(),r.prev=23,r.next=26,R(m.selected,{presetName:null==d?void 0:d.preset,contextName:null==d?void 0:d.context,instructName:null==d?void 0:d.instruct,syspromptName:null==d?void 0:d.sysprompt,maxContext:"custom"===c.maxContextType?c.maxContextValue:"profile"===c.maxContextType?"preset":"active",includeNames:!!v.selected_group});case 26:return(f=r.sent).push({role:"system",content:p}),h=!0,g=c.maxResponseToken,"openai"===m.selected?(_=L.getPresetManager("openai").getCompletionPresetByName(null==d?void 0:d.preset))&&(h=_.stream_openai,g=_.openai_max_tokens):"textgenerationwebui"===m.selected&&(y=L.getPresetManager("textgenerationwebui").getCompletionPresetByName(null==d?void 0:d.preset))&&(h=null!==(w=null!==(S=y.streaming)&&void 0!==S?S:n.textCompletionSettings.streaming)&&void 0!==w&&w,g=null!==(P=y.genamt)&&void 0!==P?P:g),T=$("#send_textarea"),A=new AbortController,r.next=35,W.generateRequest({profileId:c.profileId,prompt:f,maxTokens:g,custom:{stream:h,signal:h?A.signal:void 0}},{abortController:h?A:void 0,onStart:function(e){q=e,L.eventSource.emit(O.GENERATION_STARTED,"impersonate",{signal:h?A.signal:void 0})},onEntry:function(e){h&&e&&(T.val(e.text),T.trigger("input"),T.trigger("change"))},onFinish:function(e,t){!h&&e&&(T.val(e.content),T.trigger("input"),T.trigger("change")),t&&x("error","Error: ".concat(t)),L.activateSendButtons()}});case 35:r.next=42;break;case 37:return r.prev=37,r.t0=r.catch(23),console.error(r.t0),r.next=42,x("error","Error: ".concat(r.t0));case 42:return r.prev=42,L.activateSendButtons(),q=void 0,r.finish(42);case 46:r.next=49;break;case 48:E("impersonate",void 0,p);case 49:case"end":return r.stop()}}),r,this,[[23,37,42,46]])})))),t.find(".custom-use_action").on("click",(function(){var e=$(this).closest(".custom-roadway_option").find(".custom-option_content").text();if(e){$("#send_textarea").val(e),$("#send_textarea").trigger("input");var t=$(this);t.html("✓"),setTimeout((function(){t.html("▶️")}),1e3)}})),t.find(".custom-edit_action").on("click",k(D().mark((function r(){var o,a,i,s;return D().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:o=$(this).closest(".custom-roadway_option"),a=o.find(".custom-option_content"),i=a.text(),s=$("<textarea>").val(i).css({width:"100%",minHeight:"50px",resize:"vertical",backgroundColor:"var(--SmartThemeBlurTintColor)",color:"var(--SmartThemeBodyColor)",border:"1px solid var(--SmartThemeBorderColor)",borderRadius:"var(--avatar-base-border-radius)",padding:"calc(var(--mainFontSize) * 0.5)"}),a.empty().append(s),s.trigger("focus"),s.on("blur",(function(){var r,i=s.val();a.text(i);var c=n.chat.find((function(t,n){return e===n}));if(null!=c&&null!==(r=c.extra)&&void 0!==r&&r[F.OPTIONS]){var l=t.find(".custom-roadway_option").index(o);c.extra[F.OPTIONS][l]=i,n.saveChat()}})),s.on("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),s.trigger("blur"))}));case 8:case"end":return r.stop()}}),r,this)}))))}function K(){!function(){V.apply(this,arguments)}(),function(){L.eventSource.on(O.CHAT_CHANGED,(function(){var e,t=SillyTavern.getContext();t.chat.length&&($(".custom-roadway_options .custom-use_action").toggle(U.getSettings().showUseActionIcon),"number"==typeof(null===(e=t.chat[t.chat.length-1].extra)||void 0===e?void 0:e[F.TARGET])&&Y(t.chat.length-1))}));var e=-1;L.eventSource.makeFirst(O.CHARACTER_MESSAGE_RENDERED,(function(t,n){e=t,U.getSettings().autoTrigger&&"group_chat"!==n&&!v.selected_group&&$('[mesid="'.concat(t,'"]')).find(".mes_magic_roadway_button").trigger("click")}));var t=["normal","continue","swipe"];L.eventSource.makeFirst(O.GROUP_WRAPPER_FINISHED,(function(n){U.getSettings().autoTrigger&&-1!==e&&t.includes(n.type)&&$('[mesid="'.concat(e,'"]')).find(".mes_magic_roadway_button").trigger("click")})),$("#mes_stop").on("click",(function(){q&&W.abortRequest(q)}))}()}if(L.ConnectionManagerRequestService&&L.getCharacterCardFields&&L.getWorldInfoPrompt)U.initializeSettings().then((function(e){e.version.changed&&e.oldSettings.version<"0.4.0"&&"0.4.0"===e.newSettings.version&&x("info","[Roadway] Added impersonate with connection profile api. Check extension settings."),K()})).catch((function(e){x("error",e),L.Popup.show.confirm("Data migration failed. Do you want to reset the roadway data?","Roadway").then((function(e){e&&(U.resetSettings(),K())}))}));else{x("error","[Roadway Error] Make sure ST is updated.")}