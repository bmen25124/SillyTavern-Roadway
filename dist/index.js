import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as a from"../../../../authors-note.js";import*as s from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";var p={d:(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const l=(e=>{var t={};return p.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const u=(e=>{var t={};return p.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,characters:()=>t.characters,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,systemUserName:()=>t.systemUserName,system_avatar:()=>t.system_avatar,this_chid:()=>t.this_chid});const m=(e=>{var t={};return p.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names});const f=(e=>{var t={};return p.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const d=(e=>{var t={};return p.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const h=(e=>{var t={};return p.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const g=(e=>{var t={};return p.d(t,e),t})({metadata_keys:()=>a.metadata_keys});const y=(e=>{var t={};return p.d(t,e),t})({getGroupDepthPrompts:()=>s.getGroupDepthPrompts,selected_group:()=>s.selected_group});const v=(e=>{var t={};return p.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});async function _(e,t){await SillyTavern.getContext().SlashCommandParser.commands.echo.callback({severity:e},t)}function x(e){return(0,u.getMaxContextSize)(e)}function w(e,t){return(0,u.parseMesExamples)(e,t)}function b(e,t,n){return(0,u.baseChatReplace)(e,t,n)}function P(e){return(0,h.getPromptRole)(e)}function S(e,{wiFormat:t}={}){return(0,h.formatWorldInfo)(e,{wiFormat:t})}function E(e){return(0,h.getPromptPosition)(e)}async function I(e,t,{presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:a}={}){if(!e)throw new Error("API is required");if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const s=SillyTavern.getContext();let c=[],{description:p,personality:_,persona:I,scenario:O,mesExamples:k,system:C,jailbreak:T}=s.getCharacterCardFields();const M="textgenerationwebui"===e?s.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,N=!!M?.enabled;let j=w(k,N);const A=function(){if(!a)return x();if("number"==typeof a)return a;if("active"===a||!n)return x();if("number"==typeof a)return a;let t;if("textgenerationwebui"===e){const e=s.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=s.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return t||x()}(),R=s.ToolManager.isToolCallingSupported();let L=s.chat.slice(0,t?t+1:void 0).filter((e=>!e.is_system||R&&Array.isArray(e.extra?.tool_invocations)));L=await Promise.all(L.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a}){return(0,v.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:a})}(e.mes,e.is_user?v.regex_placement.USER_INPUT:v.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:L.length-t-1});return n=await async function(e,t){return await(0,d.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const D=L.map((e=>m.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:B,worldInfoBefore:U,worldInfoAfter:F,worldInfoExamples:$,worldInfoDepth:G,anBefore:q,anAfter:H}=await s.getWorldInfoPrompt(D,A,!1);for(const ee of $){const te=ee.content;if(0===te.length)continue;const ne=w(b(te,u.name1,u.name2),N);ee.position===m.wi_anchor_position.before?j.unshift(...ne):j.push(...ne)}if("textgenerationwebui"===e){const re=[...j];j&&(j=function(e,t,n){return(0,f.formatInstructModeExamples)(e,t,n)}(j,u.name1,u.name2));const oe=s.getPresetManager("sysprompt")?.getCompletionPresetByName(i);oe&&(C=s.powerUserSettings.prefer_character_prompt&&C?C:b(oe.content,u.name1,u.name2),C=N?(W=s.substituteParams(C,u.name1,u.name2,oe.content),Y=M,(0,f.formatInstructModeSystemPrompt)(W,Y)):C);const ie={description:p,personality:_,persona:s.powerUserSettings.persona_description_position==l.persona_description_positions.IN_PROMPT?I:"",scenario:O,system:C,char:u.name2,user:u.name1,wiBefore:U,wiAfter:F,loreBefore:U,loreAfter:F,mesExamples:j.join(""),mesExamplesRaw:re.join("")},ae=s.getPresetManager("context")?.getCompletionPresetByName(o);let se=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,l.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(ie,{customInstructSettings:M,customStoryString:ae?.story_string});c.push({role:"system",content:se,ignoreInstruct:!0});let ce=0;const pe=[];for(let le=L.length-1;le>=0;le--){const ue=L[le];if(ue.extra?.token_count&&ce+ue.extra.token_count>A)break;ce+=ue.extra?.token_count||0,pe.unshift({role:ue.is_user?"user":"assistant",content:ue.mes})}c.push(...pe)}else{let me=(V=L,(0,h.setOpenAIMessages)(V)),fe=function(e){return(0,h.setOpenAIMessageExamples)(e)}(j);async function de(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:c,quietImage:p,extensionPrompts:l,cyclePrompt:u,systemPromptOverride:m,jailbreakPromptOverride:f,personaDescription:d,messages:g,messageExamples:y},v){return(0,h.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:a,type:s,quietPrompt:c,quietImage:p,cyclePrompt:u,systemPromptOverride:m,jailbreakPromptOverride:f,personaDescription:d,extensionPrompts:l,messages:g,messageExamples:y},v)}({name2:u.name2,charDescription:p,charPersonality:_,Scenario:O,worldInfoBefore:U,worldInfoAfter:F,extensionPrompts:s.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:C,jailbreakPromptOverride:T,personaDescription:I,messages:me,messageExamples:fe},!1);c.push(...e)}if(!n)return await de(),c;const he=s.getPresetManager("openai")?.getCompletionPresetByName(n);if(!he)return console.warn(`Preset not found: ${n}. Using current preset.`),de(),c;let ge=he.prompt_order.find((e=>e.character_id===u.this_chid));if(!ge&&he.prompt_order.length>0&&(ge=he.prompt_order[0]),!ge)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),de(),c;const ye=O&&he.scenario_format?s.substituteParams(he.scenario_format):"",ve=_&&he.personality_format?s.substituteParams(he.personality_format):"",_e=s.substituteParams(he.group_nudge_prompt),xe=he.impersonation_prompt?s.substituteParams(he.impersonation_prompt):"",we=[{role:"system",content:S(U,{wiFormat:he.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:S(F,{wiFormat:he.wi_format}),identifier:"worldInfoAfter"},{role:"system",content:p,identifier:"charDescription"},{role:"system",content:ve,identifier:"charPersonality"},{role:"system",content:ye,identifier:"scenario"},{role:"system",content:xe,identifier:"impersonate"},{role:"system",content:_e,identifier:"groupNudge"}],be=s.extensionPrompts["1_memory"];be&&be.value&&we.push({role:P(be.role),content:be.value,identifier:"summary",position:E(be.position)});const Pe=s.extensionPrompts["2_floating_prompt"];Pe&&Pe.value&&we.push({role:P(Pe.role),content:Pe.value,identifier:"authorsNote",position:E(Pe.position)});const Se=s.extensionPrompts["3_vectors"];Se&&Se.value&&we.push({role:"system",content:Se.value,identifier:"vectorsMemory",position:E(Se.position)});const Ee=s.extensionPrompts["4_vectors_data_bank"];Ee&&Ee.value&&we.push({role:P(Ee.role),content:Ee.value,identifier:"vectorsDataBank",position:E(Ee.position)});const Ie=s.extensionPrompts.chromadb;Ie&&Ie.value&&we.push({role:"system",content:Ie.value,identifier:"smartContext",position:E(Ie.position)}),s.powerUserSettings.persona_description&&s.powerUserSettings.persona_description_position===l.persona_description_positions.IN_PROMPT&&we.push({role:"system",content:s.powerUserSettings.persona_description,identifier:"personaDescription"}),ge.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,we.find((e=>e.identifier===n)));var n;if(t&&t.content)c.push({role:t.role??"system",content:s.substituteParams(t.content)});else if("chatHistory"===e.identifier){let e=0;const t=[];for(let n=L.length-1;n>=0;n--){const r=L[n];if(r.extra?.token_count&&e+r.extra.token_count>A)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:r.mes})}c.push(...t)}}))}var V,W,Y;const z=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Oe in s.extensionPrompts)if(Object.hasOwn(s.extensionPrompts,Oe)){const ke=s.extensionPrompts[Oe];if(z.includes(Oe))continue;if(!s.extensionPrompts[Oe].value)continue;if(![u.extension_prompt_types.BEFORE_PROMPT,u.extension_prompt_types.IN_PROMPT].includes(ke.position))continue;if("function"==typeof ke.filter&&!await ke.filter())continue;ke.position===u.extension_prompt_types.BEFORE_PROMPT?c=[...c.slice(0,ke.depth),{role:P(ke.role)??"system",content:ke.value},...c.slice(ke.depth)]:ke.position===u.extension_prompt_types.IN_PROMPT&&(c=[...c.slice(0,c.length-ke.depth),{role:P(ke.role)??"system",content:ke.value},...c.slice(c.length-ke.depth)])}for(const Ce of G)c=[...c.slice(0,c.length-Ce.depth),{role:P(Ce.role),content:Ce.entries.join("\n")},...c.slice(c.length-Ce.depth)];const Q=(J=y.selected_group,K=Number(u.this_chid),(0,y.getGroupDepthPrompts)(J,K));var J,K;if(y.selected_group&&Array.isArray(Q)&&Q.length>0)Q.forEach(((e,t)=>{c=[...c.slice(0,c.length-e.depth),{role:e.role,content:e.text},...c.slice(c.length-e.depth)]}));else{const Te=b(u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),u.name1,u.name2)||"",Me=u.depth_prompt_depth_default,Ne=u.characters[u.this_chid]?.data?.extensions?.depth_prompt?.role??u.depth_prompt_role_default;c=[...c.slice(0,c.length-Me),{role:P(Ne),content:Te},...c.slice(c.length-Me)]}const X={prompt:u.chat_metadata[g.metadata_keys.prompt],interval:u.chat_metadata[g.metadata_keys.interval],position:u.chat_metadata[g.metadata_keys.position],depth:u.chat_metadata[g.metadata_keys.depth],role:u.chat_metadata[g.metadata_keys.role]};let Z=-1;if(X.prompt)switch(X.prompt=b(X.prompt,u.name1,u.name2),X.position){case u.extension_prompt_types.IN_PROMPT:c=[...c.slice(0,1),{role:"user",content:X.prompt},...c.slice(1)],Z=1;break;case u.extension_prompt_types.IN_CHAT:c=[...c.slice(0,c.length-X.depth),{role:P(X.role),content:X.prompt},...c.slice(c.length-X.depth)],Z=c.length-X.depth-1;break;case u.extension_prompt_types.BEFORE_PROMPT:c.unshift({role:"user",content:X.prompt}),Z=0}return Z>=0&&(q.length>0&&(c=[...c.slice(0,Z),{role:"system",content:q.join("\n")},...c.slice(Z)],Z++),H.length>0&&(c=[...c.slice(0,Z+1),{role:"system",content:H.join("\n")},...c.slice(Z+1)])),c}function O(e){return O="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},O(e)}function k(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=O(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=O(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==O(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */C=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},a=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function p(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{p({},"")}catch(e){p=function(e,t,n){return e[t]=n}}function l(e,t,n,r){var i=t&&t.prototype instanceof y?t:y,a=Object.create(i.prototype),s=new N(r||[]);return o(a,"_invoke",{value:I(e,n,s)}),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=l;var m="suspendedStart",f="suspendedYield",d="executing",h="completed",g={};function y(){}function v(){}function _(){}var x={};p(x,a,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(j([])));b&&b!==n&&r.call(b,a)&&(x=b);var P=_.prototype=y.prototype=Object.create(x);function S(e){["next","throw","return"].forEach((function(t){p(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function n(o,i,a,s){var c=u(e[o],e,i);if("throw"!==c.type){var p=c.arg,l=p.value;return l&&"object"==O(l)&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(l).then((function(e){p.value=e,a(p)}),(function(e){return n("throw",e,a,s)}))}s(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function I(t,n,r){var o=m;return function(i,a){if(o===d)throw Error("Generator is already running");if(o===h){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var c=k(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===m)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=d;var p=u(t,n,r);if("normal"===p.type){if(o=r.done?h:f,p.arg===g)continue;return{value:p.arg,done:r.done}}"throw"===p.type&&(o=h,r.method="throw",r.arg=p.arg)}}}function k(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=u(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var a=i.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function M(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function N(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function j(t){if(t||""===t){var n=t[a];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(O(t)+" is not iterable")}return v.prototype=_,o(P,"constructor",{value:_,configurable:!0}),o(_,"constructor",{value:v,configurable:!0}),v.displayName=p(_,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,p(e,c,"GeneratorFunction")),e.prototype=Object.create(P),e},t.awrap=function(e){return{__await:e}},S(E.prototype),p(E.prototype,s,(function(){return this})),t.AsyncIterator=E,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new E(l(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},S(P),p(P,c,"Generator"),p(P,a,(function(){return this})),p(P,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=j,N.prototype={constructor:N,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(M),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=r.call(a,"catchLoc"),p=r.call(a,"finallyLoc");if(c&&p){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!p)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),M(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;M(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:j(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function T(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function M(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){T(i,r,o,a,s,"next",e)}function s(e){T(i,r,o,a,s,"throw",e)}a(void 0)}))}}var N=SillyTavern.getContext(),j="roadway_target_chat",A="roadway_raw_content",R="roadway";function L(){return SillyTavern.getContext().extensionSettings[R]}var D={enabled:!0,profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:500,prompt:"You are an AI assistant designed to generate creative possible actions in a roleplaying scenario. Given the following context, suggest a diverse list of options for the player to take.\n\nOutput ONLY a numbered list of the possible actions. Each action should be a clear, actionable, and concise sentence written in plain text. Include actions that relate to multiple domains (e.g., observation, manipulation, dialogue, combat, deduction.) Do not include greetings, farewells, or polite thanks in the list. Do not use words like \"you\". Use exact 10 actions.\n\nExample:\n\n1. Examine the ground for any signs of footprints or disturbed earth.\n2. Ask Mrs. Abernathy about any local rumors regarding the strange symbol.\n3. Search Mr. Peterson's abandoned house for any hidden messages or clues.\n4. Attempt to pick the lock on the neighbor's shed, hoping to find something related to their disappearances.\n5. Show the photo of the symbol to the local bartender for information."};function B(){return(B=M(C().mark((function e(){var t,n,r,o,i,a,s,c,p;return C().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return p=function(e){var t=document.createElement("details"),n=document.createElement("summary"),r=document.createElement("pre");return n.textContent="Roadway",r.textContent=e,t.append(n,r),t.outerHTML},e.next=3,N.renderExtensionTemplateAsync("third-party/".concat("SillyTavern-Roadway"),"templates/settings");case 3:t=e.sent,$("#extensions_settings").append(t),(n=$(".roadway_settings")).find("#roadway_enabled").prop("checked",L().enabled).on("change",M(C().mark((function e(){var t,n;return C().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=SillyTavern.getContext(),(n=L()).enabled=!n.enabled,t.saveSettingsDebounced();case 4:case"end":return e.stop()}}),e)})))),N.ConnectionManagerRequestService.handleDropdown(".roadway_settings .connection_profile",L().profileId,(function(e){var t=SillyTavern.getContext();L().profileId=e?e.id:"",t.saveSettingsDebounced()})),(r=n.find(".prompt")).val(L().prompt),r.on("change",(function(){var e=SillyTavern.getContext(),t=r.val(),n=L();t!==n.prompt&&(n.prompt=t,e.saveSettingsDebounced())})),n.find(".restore_default").on("click",(function(){r.val(D.prompt),r.trigger("change")})),o=n.find(".max_context_type"),i=n.find(".max_context_value"),a=n.find(".max_context_custom"),o.val(L().maxContextType),i.val(L().maxContextValue),"custom"===L().maxContextType&&a.show(),o.on("change",(function(){var e=SillyTavern.getContext(),t=L(),n=$(this).val();t.maxContextType=n,a.toggle("custom"===n),e.saveSettingsDebounced()})),i.on("change",(function(){var e=SillyTavern.getContext();L().maxContextValue=Number($(this).val()),e.saveSettingsDebounced()})),(s=n.find(".max_response_tokens")).val(L().maxResponseToken),s.on("change",(function(){var e=SillyTavern.getContext();L().maxResponseToken=Number($(this).val()),e.saveSettingsDebounced()})),c=$('<div title="Generate Roadway" class="mes_button mes_magic_roadway_button fa-solid fa-road interactable" tabindex="0"></div>'),$("#message_template .mes_buttons .extraMesButtons").prepend(c),$(document).on("click",".mes_magic_roadway_button",M(C().mark((function e(){var t,n,r,o,i,a,s,c,l,m,f,d,h,g,y,v;return C().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=SillyTavern.getContext(),(r=L()).profileId){e.next=6;break}return e.next=5,_("error","Please select a connection profile first in the settings.");case 5:case 9:return e.abrupt("return");case 6:if(r.prompt){e.next=10;break}return e.next=9,_("error","Please enter a prompt first in the settings.");case 10:return o=$(this).closest(".mes"),i=Number(o.attr("mesid")),a=null===(t=n.extensionSettings.connectionManager)||void 0===t||null===(t=t.profiles)||void 0===t?void 0:t.find((function(e){return e.id===r.profileId})),s=null==a?void 0:a.preset,c=null==a?void 0:a.context,l=null==a?void 0:a.instruct,m=null==a?void 0:a.sysprompt,f=null!=a&&a.api?n.CONNECT_API_MAP[a.api]:null,e.prev=18,e.next=21,I(null==f?void 0:f.selected,i,{presetName:s,contextName:c,instructName:l,syspromptName:m,maxContext:"custom"===r.maxContextType?r.maxContextValue:"profile"===r.maxContextType?"preset":"active"});case 21:return(d=e.sent).push({content:r.prompt,role:"system"}),e.next=25,n.ConnectionManagerRequestService.sendRequest(r.profileId,d,r.maxResponseToken);case 25:return h=e.sent,g=n.chat.find((function(e){var t;return(null===(t=e.extra)||void 0===t?void 0:t[j])===i})),y=null!=g?g:{mes:p(h.content),name:u.systemUserName,force_avatar:u.system_avatar,is_system:!0,is_user:!1,extra:k(k({isSmallSys:!0},j,i),A,h.content)},g?(y.mes=p(h.content),y.extra[A]=h.content,v=n.chat.indexOf(g),$('[mesid="'.concat(v,'"] .mes_text pre')).text(h.content)):(n.chat.push(y),n.addOneMessage(y,{insertAfter:i})),e.next=31,n.saveChat();case 31:e.next=38;break;case 33:return e.prev=33,e.t0=e.catch(18),console.error(e.t0),e.next=38,_("error","Error: ".concat(e.t0));case 38:case"end":return e.stop()}}),e,this,[[18,33]])}))));case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){var e;N.extensionSettings[R]=(null===(e=N.extensionSettings)||void 0===e?void 0:e[R])||{};for(var t=!1,n=0,r=Object.keys(D);n<r.length;n++){var o=r[n];void 0===N.extensionSettings[R][o]&&(N.extensionSettings[R][o]=D[o],t=!0)}t&&N.saveSettingsDebounced()}(),function(){B.apply(this,arguments)}();